@page "/"
@attribute [Authorize]
@layout MainLayout
@using Domain.Entities

<PageTitle>Dashboard - Sistema de Facturación</PageTitle>

<div class="content-area">
    <div class="welcome-banner">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold text-primary">
                    <i class="fas fa-chart-line me-3"></i>Dashboard
                </h1>
                <p class="lead text-muted">Bienvenido al Sistema de Facturación Electrónica</p>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    @DateTime.Now.ToString("dddd, dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("es-EC"))
                </p>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card stat-card-blue stat-card-no-footer">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number-value">@totalClientes</span>
                    <p class="stat-label">Clientes Registrados</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card stat-card-green stat-card-no-footer">
                <div class="stat-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number-value">@totalProductos</span>
                    <p class="stat-label">Productos en Inventario</p>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card stat-card-orange">
                <div class="stat-icon">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number-value">@totalFacturasMes</span>
                    <p class="stat-label">Facturas del Mes</p>
                </div>
                <div class="stat-footer">
                    <span class="text-muted">Total: @totalFacturas facturas</span>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="stat-card stat-card-purple">
                <div class="stat-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-number-value">@($"${ventasMes:N2}")</span>
                    <p class="stat-label">Ventas del Mes</p>
                </div>
                <div class="stat-footer">
                    @if (crecimientoVentas == 0 && !hayDatosMesAnteriorVentas)
                    {
                        <span class="text-muted">Sin datos del mes anterior</span>
                    }
                    else if (crecimientoVentas >= 0)
                    {
                        <i class="fas fa-arrow-up text-success me-1"></i>
                        <span class="text-success">+@($"{crecimientoVentas:F1}")%</span>
                        <span class="text-muted"> vs. mes anterior</span>
                    }
                    else
                    {
                        <i class="fas fa-arrow-down text-danger me-1"></i>
                        <span class="text-danger">@($"{crecimientoVentas:F1}")%</span>
                        <span class="text-muted"> vs. mes anterior</span>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Accesos Rápidos -->
    <div class="section-header mb-4">
        <h4 class="fw-bold text-dark">
            <i class="fas fa-bolt me-2 text-warning"></i>Accesos Rápidos
        </h4>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6 col-lg-3">
            <a href="/clientes" class="quick-access-card">
                <div class="qa-icon qa-icon-blue">
                    <i class="fas fa-users"></i>
                </div>
                <h5 class="qa-title">Gestión de Clientes</h5>
                <p class="qa-description">Administra tu cartera de clientes</p>
                <span class="qa-arrow">→</span>
            </a>
        </div>

        <div class="col-md-6 col-lg-3">
            <a href="/productos" class="quick-access-card">
                <div class="qa-icon qa-icon-green">
                    <i class="fas fa-box"></i>
                </div>
                <h5 class="qa-title">Gestión de Productos</h5>
                <p class="qa-description">Control de inventario y lotes</p>
                <span class="qa-arrow">→</span>
            </a>
        </div>

        <div class="col-md-6 col-lg-3">
            <a href="/facturacion" class="quick-access-card">
                <div class="qa-icon qa-icon-orange">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <h5 class="qa-title">Nueva Factura</h5>
                <p class="qa-description">Emitir factura electrónica</p>
                <span class="qa-arrow">→</span>
            </a>
        </div>

        <div class="col-md-6 col-lg-3">
            <a href="/reportes" class="quick-access-card">
                <div class="qa-icon qa-icon-purple">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5 class="qa-title">Reportes</h5>
                <p class="qa-description">Análisis y estadísticas</p>
                <span class="qa-arrow">→</span>
            </a>
        </div>
    </div>

    <!-- Información Importante -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="info-card">
                <div class="info-header d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-exclamation-circle text-warning me-2"></i>
                        Facturas Pendientes
                    </h5>
                    <a href="/facturas" class="btn btn-sm btn-outline-primary">
                        Ver todas <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="info-body info-body-full" style="max-height: 500px; overflow-y: auto;">
                    @if (facturasPendientes.Any())
                    {
                        @foreach (var factura in facturasPendientes)
                        {
                            <div class="alert @GetAlertaClass(factura) border-0 mb-3" style="cursor: pointer;" @onclick="() => VerFactura(factura.Id)">
                                <div class="d-flex align-items-start">
                                    <div class="me-3">
                                        <i class="fas @GetAlertaIcono(factura) fa-lg"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <div>
                                                <strong>@factura.Numero</strong>
                                                <span class="badge @GetEstadoBadgeClass(factura.Estado, factura.EstadoSri) ms-2">
                                                    @GetEstadoDisplay(factura.Estado, factura.EstadoSri)
                                                </span>
                                            </div>
                                            <span class="fw-bold">$@factura.Total.ToString("N2")</span>
                                        </div>
                                        <div class="small mb-1">
                                            <i class="fas fa-user me-1"></i>@(factura.ClienteNombre ?? "Sin cliente")
                                        </div>
                                        <div class="small">
                                            <i class="fas fa-calendar me-1"></i>@factura.Fecha.ToString("dd/MM/yyyy HH:mm")
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(GetAccionRequerida(factura)))
                                        {
                                            <div class="mt-2">
                                                <small><strong>Acción requerida:</strong> @GetAccionRequerida(factura)</small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else if (cargandoPendientes)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted small">Cargando facturas pendientes...</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success border-0 mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>¡Excelente!</strong> No hay facturas pendientes de atención.
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="info-card">
                <div class="info-header d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-file-invoice text-primary me-2"></i>
                        Facturas Recientes
                    </h5>
                    <a href="/facturas" class="btn btn-sm btn-outline-primary">
                        Ver todas <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="info-body" style="max-height: 500px; overflow-y: auto;">
                    @if (facturasRecientes.Any())
                    {
                        @foreach (var factura in facturasRecientes)
                        {
                            <div class="activity-item mb-3 pb-3 border-bottom" style="cursor: pointer;" @onclick="() => VerFactura(factura.Id)">
                                <div class="d-flex align-items-start">
                                    <div class="activity-icon me-3">
                                        <i class="fas fa-file-invoice-dollar fa-lg" style="color: #667eea;"></i>
                                    </div>
                                    <div class="activity-content flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                            <div>
                                                <span class="fw-bold text-primary">@factura.Numero</span>
                                                <span class="badge @GetEstadoBadgeClass(factura.Estado, factura.EstadoSri) ms-2">
                                                    @GetEstadoDisplay(factura.Estado, factura.EstadoSri)
                                                </span>
                                            </div>
                                            <span class="text-success fw-bold">$@factura.Total.ToString("N2")</span>
                                        </div>
                                        <div class="text-muted small mb-1">
                                            <i class="fas fa-user me-1"></i>@(factura.ClienteNombre ?? "Sin cliente")
                                        </div>
                                        <div class="text-muted small">
                                            <i class="fas fa-calendar me-1"></i>@factura.Fecha.ToString("dd/MM/yyyy HH:mm")
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else if (cargandoFacturas)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted small">Cargando facturas...</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info border-0 mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay facturas recientes
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Asegurar que el contenido no expanda el contenedor */
    .content-area {
        max-width: 1250px !important;
        width: 100% !important;
        box-sizing: border-box;
    }

    .content-area.ampliado {
        max-width: 2200px !important;
    }

    .welcome-banner {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        max-width: 100%;
        box-sizing: border-box;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.75rem;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s, box-shadow 0.3s;
        border-left: 5px solid;
        height: 100%;
        position: relative;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    .stat-card-blue { border-left-color: #667eea; }
    .stat-card-green { border-left-color: #48bb78; }
    .stat-card-orange { border-left-color: #f6ad55; }
    .stat-card-purple { border-left-color: #9f7aea; }

    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.2;
        position: absolute;
        right: 20px;
        top: 20px;
    }

    .stat-card-blue .stat-icon { color: #667eea; }
    .stat-card-green .stat-icon { color: #48bb78; }
    .stat-card-orange .stat-icon { color: #f6ad55; }
    .stat-card-purple .stat-icon { color: #9f7aea; }

    .stat-content {
        position: relative;
        z-index: 1;
        overflow: hidden;
    }

    /* Centrar contenido cuando no hay footer */
    .stat-card-no-footer .stat-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 120px;
    }

    /* Espacio adicional entre número y label en tarjetas sin footer */
    .stat-card-no-footer .stat-number-value {
        margin-bottom: 1rem;
    }

    .stat-card-no-footer .stat-label {
        margin-bottom: 0;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    .stat-number-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2d3748;
        display: block;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.2;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .stat-card.stat-card-purple .stat-number-value {
        font-size: 1.75rem;
    }

    .stat-label {
        color: #718096;
        font-size: 0.95rem;
        margin-bottom: 1rem;
    }

    .stat-footer {
        font-size: 0.85rem;
        color: #a0aec0;
        padding-top: 1rem;
        border-top: 1px solid #e2e8f0;
    }

    .section-header {
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .quick-access-card {
        display: block;
        background: white;
        border-radius: 16px;
        padding: 2rem;
        text-decoration: none;
        color: inherit;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .quick-access-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .qa-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        margin-bottom: 1.25rem;
        color: white;
    }

    .qa-icon-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .qa-icon-green { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
    .qa-icon-orange { background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%); }
    .qa-icon-purple { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); }

    .qa-title {
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }

    .qa-description {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 0;
    }

    .qa-arrow {
        position: absolute;
        right: 20px;
        bottom: 20px;
        font-size: 1.5rem;
        color: #cbd5e0;
        transition: all 0.3s;
    }

    .quick-access-card:hover .qa-arrow {
        right: 15px;
        color: #667eea;
    }

    .info-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        height: 100%;
    }

    .info-header {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .info-body {
        padding: 1.5rem;
    }

    .info-card .info-body {
        max-height: 320px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid #f7fafc;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .bg-primary-light { background: rgba(102, 126, 234, 0.1); }
    .bg-success-light { background: rgba(72, 187, 120, 0.1); }

    .activity-content {
        flex: 1;
    }

    .activity-content p {
        font-size: 0.9rem;
        color: #2d3748;
    }

    .activity-content small {
        font-size: 0.8rem;
    }

    .activity-item {
        transition: background-color 0.2s, transform 0.2s;
        border-radius: 8px;
        padding: 0.75rem;
        margin-left: -0.75rem;
        margin-right: -0.75rem;
    }

    .activity-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .activity-icon {
        min-width: 40px;
        text-align: center;
    }

    @@media (max-width: 768px) {

        .welcome-banner {
            padding: 1.5rem;
        }

        .stat-number {
            font-size: 2rem;
        }

        .stat-number-value {
            font-size: 2rem;
        }

        .nav-text {
            font-size: 0.9rem;
        }

        .nav-badge {
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
        }
    }
</style>

@inject ProductoService productoService
@inject AuthService authService
@inject FacturaService facturaService
@inject NavigationManager Navigation
@using Application.DTOs

@code {
    private int totalClientes;
    private int totalProductos;
    private int totalFacturas;
    private int totalFacturasMes;
    private decimal ventasMes;
    private decimal crecimientoVentas;
    private bool hayDatosMesAnteriorVentas = false;
    private List<FacturaListDto> facturasRecientes = new();
    private bool cargandoFacturas = false;
    private List<FacturaListDto> facturasPendientes = new();
    private bool cargandoPendientes = false;

    protected override async Task OnInitializedAsync()
    {
        totalClientes = await authService.GetClientesCountAsync();
        totalProductos = await productoService.GetProductosCountAsync();
        
        totalFacturas = await facturaService.GetTotalFacturasAsync();
        totalFacturasMes = await facturaService.GetFacturasMesActualAsync();
        ventasMes = await facturaService.GetVentasMesActualAsync();
        
        var resultadoVentas = await facturaService.GetCrecimientoVentasAsync();
        crecimientoVentas = resultadoVentas.crecimiento;
        hayDatosMesAnteriorVentas = resultadoVentas.hayDatosAnterior;
        
        await CargarFacturasRecientes();
        await CargarFacturasPendientes();
    }

    private async Task CargarFacturasPendientes()
    {
        cargandoPendientes = true;
        try
        {
            var todasFacturas = await facturaService.ListarFacturasAsync();
            facturasPendientes = todasFacturas
                .Where(f => 
                {
                    var estadoSriUpper = f.EstadoSri?.ToUpperInvariant() ?? "";
                    var estadoLower = f.Estado?.ToLowerInvariant() ?? "";
                    
                    // Facturas que necesitan firma (sin EstadoSri y no están firmadas localmente)
                    var necesitaFirmar = string.IsNullOrWhiteSpace(f.EstadoSri) && estadoLower != "firmada";
                    
                    // Facturas firmadas pero no autorizadas
                    var necesitaAutorizar = (estadoLower == "firmada" || estadoSriUpper == "FIRMADA") 
                                          && estadoSriUpper != "AUTORIZADO" 
                                          && estadoSriUpper != "NO AUTORIZADO";
                    
                    // Facturas rechazadas que necesitan atención
                    var rechazada = estadoSriUpper == "NO AUTORIZADO";
                    
                    return necesitaFirmar || necesitaAutorizar || rechazada;
                })
                .OrderByDescending(f => f.Fecha)
                .Take(10)
                .ToList();
        }
        catch
        {
            facturasPendientes = new();
        }
        finally
        {
            cargandoPendientes = false;
        }
    }

    private async Task CargarFacturasRecientes()
    {
        cargandoFacturas = true;
        try
        {
            facturasRecientes = await facturaService.GetFacturasRecientesAsync(5);
        }
        catch
        {
            facturasRecientes = new();
        }
        finally
        {
            cargandoFacturas = false;
        }
    }

    private string GetEstadoDisplay(string? estado, string? estadoSri)
    {
        if (!string.IsNullOrWhiteSpace(estadoSri))
        {
            return estadoSri.ToUpper() switch
            {
                "AUTORIZADO" => "Autorizado",
                "NO AUTORIZADO" => "No Autorizado",
                "FIRMADA" => "Firmada",
                _ => estadoSri
            };
        }
        return estado ?? "Emitida";
    }

    private string GetEstadoBadgeClass(string? estado, string? estadoSri)
    {
        if (!string.IsNullOrWhiteSpace(estadoSri))
        {
            return estadoSri.ToUpper() switch
            {
                "AUTORIZADO" => "bg-success",
                "NO AUTORIZADO" => "bg-danger",
                "FIRMADA" => "bg-warning",
                _ => "bg-secondary"
            };
        }
        return estado?.ToLower() switch
        {
            "firmada" => "bg-warning",
            "emitida" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private void VerFactura(int facturaId)
    {
        Navigation.NavigateTo($"/facturas/consulta/{facturaId}");
    }

    private string GetAlertaClass(FacturaListDto factura)
    {
        var estadoSriUpper = factura.EstadoSri?.ToUpperInvariant() ?? "";
        var estadoLower = factura.Estado?.ToLowerInvariant() ?? "";
        
        if (estadoSriUpper == "NO AUTORIZADO")
            return "alert-danger";
        
        if (string.IsNullOrWhiteSpace(factura.EstadoSri) && estadoLower != "firmada")
            return "alert-warning";
        
        if ((estadoLower == "firmada" || estadoSriUpper == "FIRMADA") && estadoSriUpper != "AUTORIZADO")
            return "alert-info";
        
        return "alert-secondary";
    }

    private string GetAlertaIcono(FacturaListDto factura)
    {
        var estadoSriUpper = factura.EstadoSri?.ToUpperInvariant() ?? "";
        var estadoLower = factura.Estado?.ToLowerInvariant() ?? "";
        
        if (estadoSriUpper == "NO AUTORIZADO")
            return "fa-times-circle";
        
        if (string.IsNullOrWhiteSpace(factura.EstadoSri) && estadoLower != "firmada")
            return "fa-signature";
        
        if ((estadoLower == "firmada" || estadoSriUpper == "FIRMADA") && estadoSriUpper != "AUTORIZADO")
            return "fa-paper-plane";
        
        return "fa-file-invoice";
    }

    private string GetAccionRequerida(FacturaListDto factura)
    {
        var estadoSriUpper = factura.EstadoSri?.ToUpperInvariant() ?? "";
        var estadoLower = factura.Estado?.ToLowerInvariant() ?? "";
        
        if (estadoSriUpper == "NO AUTORIZADO")
            return "Revisar y corregir - Factura rechazada por el SRI";
        
        if (string.IsNullOrWhiteSpace(factura.EstadoSri) && estadoLower != "firmada")
            return "Firmar factura";
        
        if ((estadoLower == "firmada" || estadoSriUpper == "FIRMADA") && estadoSriUpper != "AUTORIZADO")
            return "Emitir al SRI para autorización";
        
        return "";
    }
}
