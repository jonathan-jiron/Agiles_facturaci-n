@page "/productos/nuevo"
@page "/productos/editar/{Id:int}"
@attribute [Authorize]
@layout MainLayout
@inject HttpClient Http
@inject NavigationManager Nav
@using Domain.Entities
@using System.ComponentModel.DataAnnotations
@using UI.Shared

<h3 class="mb-4">
    <i class="fa-solid fa-box-open me-2"></i>
    @(IsEdit ? "Editar Producto" : "Registrar Nuevo Producto")
</h3>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        @* FORMULARIO DEL PRODUCTO *@
        <EditForm Model="@productoActual" OnValidSubmit="@GuardarProducto" novalidate>
            <DataAnnotationsValidator />

            <div class="border-bottom pb-3 mb-3">
                <h6 class="text-primary"><i class="fa-solid fa-info-circle me-2"></i>Información del Producto</h6>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Código del Producto <span class="text-danger">*</span></label>
                        <InputText @bind-Value="productoActual.Codigo" class="form-control" />
                        <ValidationMessage For="@(() => productoActual.Codigo)" class="text-danger small" />
                    </div>
                    <div class="col-md-8 mb-3">
                        <label class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                        <InputText @bind-Value="productoActual.Nombre" class="form-control" />
                        <ValidationMessage For="@(() => productoActual.Nombre)" class="text-danger small" />
                    </div>
                    <div class="col-md-12 mb-3">
                        <label class="form-label">Descripción</label>
                        <InputTextArea @bind-Value="productoActual.Descripcion" class="form-control" rows="2" />
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger">@mensajeError</div>
            }
            @if (!string.IsNullOrEmpty(mensajeExito))
            {
                <div class="alert alert-success">@mensajeExito</div>
            }

            <div class="d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-success btn-lg" disabled="@(!productoActual.Lotes.Any())">
                    <i class="fa-solid fa-save me-2"></i> Guardar Producto @(productoActual.Lotes.Any() ? $"({productoActual.Lotes.Sum(l => l.Cantidad)} u.)" : "")
                </button>

                <button type="button" class="btn btn-secondary btn-lg" @onclick="Cancelar">
                    <i class="fa-solid fa-times me-2"></i> Cancelar
                </button>
            </div>
        </EditForm>

        @* SECCIÓN DE LOTES (fuera del EditForm) *@
        <div class="border-top mt-4 pt-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-success mb-0"><i class="fa-solid fa-truck-loading me-2"></i>Lotes</h6>
                <button type="button" class="btn btn-primary btn-sm" @onclick="MostrarNuevoLote"><i class="fa-solid fa-plus me-1"></i> Nuevo Lote</button>
            </div>

            @* Referencia explícita al componente en el namespace UI.Shared para evitar ambigüedad *@
            <UI.Shared.LoteEditor @ref="loteEditor" OnSave="OnLoteSaved" OnCancel="OnLoteCancelled" />

            @if (productoActual.Lotes.Any())
            {
                <div class="table-responsive mt-3">
                    <table class="table table-sm table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Nº Lote / Factura</th>
                                <th class="text-end">Cantidad</th>
                                <th class="text-end">Precio Costo</th>
                                <th class="text-end">Valor Total</th>
                                <th class="text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in productoActual.Lotes.Select((l, i) => new { L = l, Index = i }))
                            {
                                <tr>
                                    <td><strong>@item.L.NumeroLote</strong></td>
                                    <td class="text-end">@item.L.Cantidad</td>
                                    <td class="text-end">@($"${item.L.PrecioUnitario:N2}")</td>
                                    <td class="text-end"><strong class="text-success">@($"${(item.L.Cantidad * item.L.PrecioUnitario):N2}")</strong></td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-warning" @onclick="() => EditarLote(item.Index)"><i class="fa-solid fa-pen-to-square"></i></button>
                                            <button type="button" class="btn btn-danger" @onclick="() => EliminarLote(item.Index)"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-info">
                            <tr class="fw-bold">
                                <td>TOTALES</td>
                                <td class="text-end">@productoActual.Lotes.Sum(l => l.Cantidad)</td>
                                <td class="text-end">-</td>
                                <td class="text-end text-success">@($"${productoActual.Lotes.Sum(l => l.Cantidad * l.PrecioUnitario):N2}")</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning mt-3">Aún no hay lotes registrados.</div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int? Id { get; set; }
    private bool IsEdit => Id is not null && Id > 0;
    private Producto productoActual = new Producto { Lotes = new List<Lote>() };
    private string mensajeError = "";
    private string mensajeExito = "";

    // Tipo completamente cualificado para evitar ambigüedad con UI.Pages.LoteEditor
    private UI.Shared.LoteEditor? loteEditor;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            await CargarProductoPorId();
        }
        else
        {
            productoActual = new Producto { Lotes = new List<Lote>() };
        }
    }

    private void Cancelar() => Nav.NavigateTo("/productos");

    private void MostrarNuevoLote() => loteEditor?.ShowNew();

    private async Task EditarLote(int index)
    {
        var lote = productoActual.Lotes[index];
        if (loteEditor is not null)
            await loteEditor.Edit(lote, index);
    }

    private void EliminarLote(int index)
    {
        productoActual.Lotes.RemoveAt(index);
    }

    private async Task OnLoteSaved((Lote lote, int? index) payload)
    {
        var (lote, index) = payload;
        if (index is null)
        {
            productoActual.Lotes.Add(lote);
            mensajeExito = "Lote agregado.";
        }
        else
        {
            var i = (int)index;
            productoActual.Lotes[i].NumeroLote = lote.NumeroLote;
            productoActual.Lotes[i].Cantidad = lote.Cantidad;
            productoActual.Lotes[i].PrecioUnitario = lote.PrecioUnitario;
            productoActual.Lotes[i].FechaIngreso = lote.FechaIngreso;
            productoActual.Lotes[i].FechaVencimiento = lote.FechaVencimiento;
            mensajeExito = "Lote actualizado.";
        }
        StateHasChanged();
        await Task.Delay(1200);
        mensajeExito = "";
    }

    private Task OnLoteCancelled() => Task.CompletedTask;

    private async Task GuardarProducto()
    {
        mensajeError = "";
        mensajeExito = "";

        if (productoActual.Lotes == null || productoActual.Lotes.Count == 0)
        {
            mensajeError = "Debes agregar al menos un lote para guardar el producto.";
            return;
        }

        // Validar que cada lote existente sea válido (cantidad y precio positivos)
        foreach (var lote in productoActual.Lotes)
        {
            if (string.IsNullOrWhiteSpace(lote.NumeroLote))
            {
                mensajeError = "Todos los lotes deben tener número de lote/factura.";
                return;
            }
            if (lote.Cantidad < 1)
            {
                mensajeError = "Todos los lotes deben tener cantidad mayor o igual a 1.";
                return;
            }
            if (lote.PrecioUnitario <= 0)
            {
                mensajeError = "Todos los lotes deben tener precio unitario mayor a 0.";
                return;
            }
        }

        if (string.IsNullOrWhiteSpace(productoActual.Codigo) || string.IsNullOrWhiteSpace(productoActual.Nombre))
        {
            mensajeError = "Código y Nombre son requeridos.";
            return;
        }

        var dto = new
        {
            codigo = productoActual.Codigo,
            nombre = productoActual.Nombre,
            descripcion = productoActual.Descripcion,
            lotes = productoActual.Lotes.Select(l => new
            {
                numeroLote = l.NumeroLote,
                cantidad = l.Cantidad,
                precioUnitario = l.PrecioUnitario,
                fechaIngreso = l.FechaIngreso,
                fechaVencimiento = l.FechaVencimiento
            }).ToList()
        };

        HttpResponseMessage response;
        if (IsEdit)
            response = await Http.PutAsJsonAsync($"http://localhost:5240/api/productos/{Id}", dto);
        else
            response = await Http.PostAsJsonAsync("http://localhost:5240/api/productos", dto);

        if (response.IsSuccessStatusCode)
        {
            Nav.NavigateTo("/productos");
            return;
        }
        else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            mensajeError = "El código de producto ya existe.";
        }
        else
        {
            mensajeError = "Error al guardar el producto";
        }
    }

    private async Task CargarProductoPorId()
    {
        var resp = await Http.GetAsync($"http://localhost:5240/api/productos/{Id}");
        if (resp.IsSuccessStatusCode)
        {
            // Deserializar al modelo cliente (Producto con Lotes)
            var dto = await resp.Content.ReadFromJsonAsync<Producto>();
            if (dto is not null)
            {
                productoActual = dto;
                productoActual.Lotes = productoActual.Lotes ?? new List<Lote>();
            }
            else
            {
                mensajeError = "Producto no encontrado.";
            }
        }
        else
        {
            mensajeError = "Error al cargar el producto.";
        }
    }
}