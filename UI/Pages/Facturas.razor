@page "/facturas"
@* @attribute [Authorize] - Temporalmente sin auth para pruebas SRI *@
@layout MainLayout
@inject FacturaService FacturaService
@inject NavigationManager Navigation
@inject FacturaEventService FacturaEventService
@inject NotificationService NotificationService
@inject HttpClient Http
@inject IJSRuntime JS
@using Application.DTOs
@using UI.Shared
@implements IDisposable

<PageTitle>Gestión de Facturas</PageTitle>

<div class="content-area">
    <h2 class="fw-bold text-primary mb-4">
        <i class="fas fa-file-invoice me-2"></i>
        Gestión de Facturas
    </h2>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-primary mb-0" @onclick='() => Navigation.NavigateTo("/facturacion")'>
                    <i class="fas fa-plus"></i> Nueva Factura
                </button>

                <!-- Búsqueda dinámica facturas -->
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" style="width:200px" @bind="factSearchField">
                        <option value="All">Buscar en: Todo</option>
                        <option value="Numero">Número</option>
                        <option value="ClienteNombre">Cliente</option>
                        <option value="Fecha">Fecha</option>
                        <option value="Estado">Estado</option>
                    </select>
                    <input class="form-control form-control-sm" style="width:360px" placeholder="Buscar facturas..." @bind="factSearchTerm" @bind:event="oninput" />
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFactFilter" title="Limpiar búsqueda"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>

            @if (cargando)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Cargando facturas...</p>
                </div>
            }
            else if (!filteredFacturas.Any())
            {
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle"></i> No hay facturas que coincidan con la búsqueda.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle" style="width: 100%;">
                        <thead>
                            <tr class="table-info">
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var factura in paginadasFacturas)
                            {
                                <tr>
                                    <td class="fw-bold">@factura.Numero</td>
                                    <td>@(factura.ClienteNombre ?? "N/A")</td>
                                    <td>@factura.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td class="text-end fw-bold text-success">$@factura.Total.ToString("N2")</td>
                                    <td class="text-end">
                                        <span class="badge @GetEstadoBadgeClass(factura.Estado, factura.EstadoSri)">
                                            @GetEstadoDisplay(factura.Estado, factura.EstadoSri)
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        @{
                                            var estadoSriUpper = factura.EstadoSri?.ToUpperInvariant() ?? "";
                                            var estadoLower = factura.Estado?.ToLowerInvariant() ?? "";
                                            // Puede firmar si no tiene EstadoSri y el estado local no es "firmada"
                                            var puedeFirmar = string.IsNullOrWhiteSpace(factura.EstadoSri) && estadoLower != "firmada";
                                            // Puede emitir si está firmada (local o EstadoSri="FIRMADA") y no está autorizada
                                            var puedeEmitir = (estadoLower == "firmada" || estadoSriUpper == "FIRMADA") 
                                                              && estadoSriUpper != "AUTORIZADO" && estadoSriUpper != "NO AUTORIZADO";
                                            var estaAutorizada = estadoSriUpper == "AUTORIZADO";
                                            var tieneClaveAcceso = !string.IsNullOrWhiteSpace(factura.ClaveAcceso);
                                        }
                                        
                                        @if (puedeFirmar)
                                        {
                                            <button class="btn btn-warning btn-sm me-1" @onclick="() => FirmarFactura(factura.Id)" title="Firmar Factura">
                                                <i class="fas fa-signature"></i> Firmar
                                            </button>
                                            <button class="btn btn-primary btn-sm me-1" @onclick="() => VerDetalle(factura.Id)" title="Ver Consulta">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        }
                                        
                                        @if (puedeEmitir)
                                        {
                                            <button class="btn btn-success btn-sm me-1" @onclick="() => EmitirSri(factura.Id)" title="Emitir al SRI">
                                                <i class="fas fa-paper-plane"></i> Emitir SRI
                                            </button>
                                        }
                                        
                                        @if (tieneClaveAcceso || estadoLower == "firmada" || !string.IsNullOrWhiteSpace(factura.EstadoSri))
                                        {
                                            <button class="btn btn-primary btn-sm me-1" @onclick="() => VerDetalle(factura.Id)" title="Ver Detalle">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            @if (tieneClaveAcceso)
                                            {
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-secondary btn-sm" @onclick="() => DescargarPDF(factura.Id)" title="Descargar PDF">
                                                        <i class="fas fa-file-pdf"></i>
                                                    </button>
                                                    <button class="btn btn-info btn-sm" @onclick="() => DescargarXML(factura.Id)" title="Descargar XML">
                                                        <i class="fas fa-file-code"></i>
                                                    </button>
                                                    <button class="btn btn-success btn-sm" @onclick="() => EnviarPorEmail(factura.Id)" title="Enviar por Correo">
                                                        <i class="fas fa-envelope"></i>
                                                    </button>
                                                </div>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>

    @if (totalPaginas > 1)
    {
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mt-3">
            <div class="mb-2 mb-md-0 text-muted small">
                Página <span class="fw-bold">@paginaActual</span> de <span class="fw-bold">@totalPaginas</span>
            </div>
            <nav aria-label="Paginación de facturas">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => CambiarPagina(paginaActual - 1)">
                            <i class="fas fa-angle-left"></i>
                        </button>
                    </li>
                    @for (int i = 1; i <= totalPaginas; i++)
                    {
                        var pagina = i;
                        <li class="page-item @(paginaActual == pagina ? "active" : "")">
                            <button class="page-link" @onclick="() => CambiarPagina(pagina)">
                                @pagina
                            </button>
                        </li>
                    }
                    <li class="page-item @(paginaActual == totalPaginas ? "disabled" : "")">
                        <button class="page-link" @onclick="() => CambiarPagina(paginaActual + 1)">
                            <i class="fas fa-angle-right"></i>
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    }
</div>

@code {
    private List<FacturaListDto> facturas = new();
    private bool cargando = true;

    // búsqueda dinámica
    private string factSearchTerm = "";
    private string factSearchField = "All";

    private int paginaActual = 1;
    private int itemsPorPagina = 10;
    private int totalPaginas => (int)Math.Ceiling((double)filteredFacturas.Count() / itemsPorPagina);
    private IEnumerable<FacturaListDto> paginadasFacturas => filteredFacturas.Skip((paginaActual - 1) * itemsPorPagina).Take(itemsPorPagina);

    private IEnumerable<FacturaListDto> filteredFacturas => GetFilteredFacturas();

    protected override async Task OnInitializedAsync()
    {
        FacturaEventService.FacturaGuardada += OnFacturaGuardada;
        await CargarFacturas();
    }

    private async void OnFacturaGuardada()
    {
        await CargarFacturas();
        StateHasChanged();
    }

    public void Dispose()
    {
        FacturaEventService.FacturaGuardada -= OnFacturaGuardada;
    }

    private async Task CargarFacturas()
    {
        cargando = true;
        try
        {
            facturas = await FacturaService.ListarFacturasAsync();
            facturas = facturas.OrderByDescending(f => f.Fecha).ToList();
        }
        finally
        {
            cargando = false;
        }
    }

    private IEnumerable<FacturaListDto> GetFilteredFacturas()
    {
        if (string.IsNullOrWhiteSpace(factSearchTerm)) return facturas;

        var term = factSearchTerm.Trim().ToLowerInvariant();

        return facturas.Where(f =>
        {
            return factSearchField switch
            {
                "Numero" => (f.Numero ?? "").ToLowerInvariant().Contains(term),
                "ClienteNombre" => (f.ClienteNombre ?? "").ToLowerInvariant().Contains(term),
                "Fecha" => f.Fecha.ToString("dd/MM/yyyy HH:mm").ToLowerInvariant().Contains(term),
                "Estado" => (f.Estado ?? "").ToLowerInvariant().Contains(term),
                _ => (
                        (f.Numero ?? "").ToLowerInvariant().Contains(term)
                        || (f.ClienteNombre ?? "").ToLowerInvariant().Contains(term)
                        || f.Fecha.ToString("dd/MM/yyyy HH:mm").ToLowerInvariant().Contains(term)
                        || (f.Estado ?? "").ToLowerInvariant().Contains(term)
                    )
            };
        });
    }

    private void ClearFactFilter()
    {
        factSearchTerm = "";
        factSearchField = "All";
    }

    private void VerDetalle(int facturaId)
    {
        Navigation.NavigateTo($"/facturas/consulta/{facturaId}");
    }

    private void CambiarPagina(int nuevaPagina)
    {
        if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas)
        {
            paginaActual = nuevaPagina;
        }
    }

    private string GetEstadoBadgeClass(string? estado, string? estadoSri = null) 
    {
        // Priorizar estado SRI si existe
        if (!string.IsNullOrWhiteSpace(estadoSri))
        {
            return estadoSri.ToUpperInvariant() switch
            {
                "AUTORIZADO" => "bg-success",
                "RECIBIDA" => "bg-info",
                "FIRMADA" => "bg-primary",
                "NO AUTORIZADO" => "bg-danger",
                "RECHAZADO" => "bg-danger",
                "DEVUELTA" => "bg-warning text-dark",
                _ => "bg-secondary"
            };
        }
        
        // Fallback al estado local
        return estado?.ToLower() switch
        {
            "firmada" => "bg-success",
            "autorizada" => "bg-success",
            "guardada" => "bg-warning text-dark",
            "generada" => "bg-warning text-dark",
            "rechazada" => "bg-danger",
            "enviada" => "bg-info",
            _ => "bg-secondary"
        };
    }
    
    private string GetEstadoDisplay(string? estado, string? estadoSri = null)
    {
        if (!string.IsNullOrWhiteSpace(estadoSri))
            return estadoSri;
        return estado ?? "N/A";
    }

    private async Task FirmarFactura(int facturaId)
    {
        NotificationService.ShowInfo("Firmando factura...");
        var resultado = await FacturaService.FirmarFacturaAsync(facturaId);
        if (resultado != null && resultado.Exito)
        {
            var mensaje = $"Factura {resultado.Numero} firmada correctamente.";
            if (!string.IsNullOrEmpty(resultado.ClaveAcceso))
                mensaje += $"\nClave de Acceso: {resultado.ClaveAcceso}";
            NotificationService.ShowSuccess(mensaje);
            await CargarFacturas(); // Recargar lista para mostrar estado actualizado
        }
        else
        {
            var errorMsg = resultado?.Error ?? "No se pudo firmar la factura.";
            NotificationService.ShowError($"Error al firmar: {errorMsg}");
        }
    }

    private async Task EmitirSri(int facturaId)
    {
        NotificationService.ShowInfo("Emitiendo factura al SRI...");
        var resultado = await FacturaService.EmitirSriAsync(facturaId);
        if (resultado != null)
        {
            if (!string.IsNullOrEmpty(resultado.Error))
            {
                NotificationService.ShowError($"Error al emitir al SRI: {resultado.Error}");
            }
            else
            {
                var mensaje = $"Estado SRI: {resultado.EstadoSri}";
                if (!string.IsNullOrEmpty(resultado.ClaveAcceso))
                    mensaje += $"\nClave de Acceso: {resultado.ClaveAcceso}";
                if (resultado.EstadoSri == "AUTORIZADO")
                {
                    NotificationService.ShowSuccess($"Factura autorizada por el SRI.\n{mensaje}");
                }
                else if (resultado.EstadoSri == "RECIBIDA")
                {
                    NotificationService.ShowInfo($"Factura recibida por el SRI. Esperando autorización.\n{mensaje}");
                }
                else
                {
                    NotificationService.ShowWarning($"Estado del SRI: {resultado.EstadoSri}\n{mensaje}");
                    if (!string.IsNullOrEmpty(resultado.MensajesSri))
                        NotificationService.ShowWarning($"Mensajes: {resultado.MensajesSri}");
                }
                await CargarFacturas();
            }
        }
        else
        {
            NotificationService.ShowError("No se pudo emitir la factura al SRI.");
        }
    }

    private async Task DescargarPDF(int facturaId)
    {
        try
        {
            var pdfBytes = await FacturaService.DescargarPDFAsync(facturaId);
            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                await JS.InvokeVoidAsync("downloadFile", $"Factura_{facturaId}.pdf", Convert.ToBase64String(pdfBytes), "application/pdf");
                NotificationService.ShowSuccess("PDF descargado correctamente.");
            }
            else
            {
                NotificationService.ShowError("No se pudo generar el PDF.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error al descargar PDF: {ex.Message}");
        }
    }

    private async Task DescargarXML(int facturaId)
    {
        try
        {
            // Obtener el XML desde el backend
            var xmlResp = await Http.GetAsync($"api/facturas/{facturaId}/xml");
            if (xmlResp.IsSuccessStatusCode)
            {
                var xmlContent = await xmlResp.Content.ReadAsStringAsync();
                var xmlBytes = System.Text.Encoding.UTF8.GetBytes(xmlContent);
                await JS.InvokeVoidAsync("downloadFile", $"Factura_{facturaId}.xml", Convert.ToBase64String(xmlBytes), "application/xml");
                NotificationService.ShowSuccess("XML descargado correctamente.");
            }
            else
            {
                var error = await xmlResp.Content.ReadAsStringAsync();
                NotificationService.ShowError($"No se pudo obtener el XML: {error}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error al descargar XML: {ex.Message}");
        }
    }

    private async Task EnviarPorEmail(int facturaId)
    {
        NotificationService.ShowInfo("Enviando factura por correo...");
        var resultado = await FacturaService.EnviarFacturaPorEmailAsync(facturaId);
        if (resultado != null && resultado.Exito)
        {
            var mensaje = resultado.Mensaje ?? "Correo enviado correctamente al cliente.";
            NotificationService.ShowSuccess(mensaje);
        }
        else
        {
            var errorMsg = resultado?.Error ?? "No se pudo enviar el correo.";
            NotificationService.ShowError($"Error al enviar correo: {errorMsg}");
        }
    }
}

<style>
    /* Asegurar que el contenido no expanda el contenedor */
    .content-area {
        max-width: 1250px !important;
        width: 100% !important;
        box-sizing: border-box;
    }

    .content-area.ampliado {
        max-width: 2200px !important;
    }

    .card {
        max-width: 100%;
        box-sizing: border-box;
    }

    .table-responsive {
        max-width: 100%;
        overflow-x: auto;
    }
</style>
