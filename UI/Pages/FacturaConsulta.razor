@page "/facturas/consulta/{Id:int}"
@* @attribute [Authorize] - Temporalmente sin auth para pruebas *@
@inject FacturaService FacturaService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject HttpClient Http
@inject NotificationService NotificationService

<PageTitle>Consultar Documento Electrónico</PageTitle>

<div class="content-area">
    <h2 class="fw-bold text-primary mb-4">
        <i class="fas fa-file-invoice me-2"></i>
        Consulta de Factura Electrónica
    </h2>
    <p class="text-muted mb-4">Detalle y resumen del documento firmado</p>

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Cargando factura...</p>
        </div>
    }
    else if (factura == null)
    {
        <div class="alert alert-danger mt-4">
            <i class="fas fa-exclamation-triangle me-2"></i>No se encontró la factura.
        </div>
    }
    else
    {
        var estadoDisplay = GetEstadoDisplay(factura.Estado, factura.EstadoSri);
        var estadoBadgeClass = GetEstadoBadgeClass(factura.Estado, factura.EstadoSri);
        var estadoIcon = GetEstadoIcon(factura.Estado, factura.EstadoSri);
        var alertClass = GetEstadoAlertClass(factura.Estado, factura.EstadoSri);
        
        <div class="alert @alertClass mb-3">
            <i class="fas @estadoIcon me-2"></i>Estado: @estadoDisplay
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white fw-bold">
                Datos Generales
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Fecha de Emisión:</strong></div>
                    <div class="col-md-3">@factura.Fecha.ToString("dd/MM/yyyy")</div>
                    <div class="col-md-3"><strong>Tipo de Documento:</strong></div>
                    <div class="col-md-3">Cliente - Factura</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong># de Documento:</strong></div>
                    <div class="col-md-3">@factura.Numero</div>
                    <div class="col-md-3"><strong>Persona:</strong></div>
                    <div class="col-md-3">@factura.ClienteNombre</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Vencimiento:</strong></div>
                    <div class="col-md-3">0 días</div>
                    <div class="col-md-3"><strong>Código de sustentente:</strong></div>
                    <div class="col-md-3">Cod. 01</div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3"><strong>Estado:</strong></div>
                    <div class="col-md-3">
                        <span class="badge @estadoBadgeClass">
                            @estadoDisplay
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">
                Detalle de Productos/Servicios
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle" style="width: 100%;">
                        <thead class="table-light">
                            <tr>
                                <th>Cant</th>
                                <th>Unidad</th>
                                <th>Precio U.</th>
                                <th>Ret. IR</th>
                                <th>Ret. IVA</th>
                                <th>% Desc</th>
                                <th>Desc</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in factura.Detalles)
                            {
                                <tr>
                                    <td>@d.Cantidad</td>
                                    <td>@d.ProductoNombre</td>
                                    <td class="text-end">$@d.PrecioUnitario.ToString("N2")</td>
                                    <td class="text-end">0.00%</td>
                                    <td class="text-end">0.00%</td>
                                    <td class="text-end">@d.DescuentoPorcentaje.ToString("N2")%</td>
                                    <td class="text-end">$@d.Descuento.ToString("N2")</td>
                                    <td class="text-end">$@d.Subtotal.ToString("N2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @if (factura.Pagos != null && factura.Pagos.Any())
        {
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light fw-bold">
                    Formas de Pago
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width:40px;">#</th>
                                    <th>Forma de Pago</th>
                                    <th class="text-end">Monto</th>
                                    @if (factura.Pagos.Any(p => !string.IsNullOrWhiteSpace(p.NumeroComprobante)))
                                    {
                                        <th>N° Comprobante</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var pago in factura.Pagos.OrderBy(p => p.Orden))
                                {
                                    <tr>
                                        <td>@pago.Orden</td>
                                        <td>@pago.FormaPago</td>
                                        <td class="text-end">$@pago.Monto.ToString("N2")</td>
                                        @if (factura.Pagos.Any(p => !string.IsNullOrWhiteSpace(p.NumeroComprobante)))
                                        {
                                            <td>@(pago.NumeroComprobante ?? "-")</td>
                                        }
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="fw-bold">
                                    <td colspan="@(factura.Pagos.Any(p => !string.IsNullOrWhiteSpace(p.NumeroComprobante)) ? 3 : 2)" class="text-end">Total Pagado:</td>
                                    <td class="text-end text-success">$@factura.Pagos.Sum(p => p.Monto).ToString("N2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        }

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light fw-bold">
                Resumen
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="fw-bold mb-3">Observaciones</h6>
                        <p class="text-muted">@(string.IsNullOrWhiteSpace(factura.Observaciones) ? "Sin observaciones" : factura.Observaciones)</p>
                    </div>
                    <div class="col-md-9">
                        <div class="row mb-2">
                            <div class="col-md-6 text-end">Subtotal 15%:</div>
                            <div class="col-md-6">$@factura.Subtotal12.ToString("N2")</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6 text-end">Subtotal 0%:</div>
                            <div class="col-md-6">$@factura.Subtotal0.ToString("N2")</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6 text-end">Descuento:</div>
                            <div class="col-md-6">$@factura.DescuentoTotal.ToString("N2")</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6 text-end">IVA:</div>
                            <div class="col-md-6">$@factura.Iva.ToString("N2")</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6 text-end">ICE:</div>
                            <div class="col-md-6">$@factura.IceTotal.ToString("N2")</div>
                        </div>
                        <div class="row mb-2 fw-bold">
                            <div class="col-md-6 text-end">Total:</div>
                            <div class="col-md-6 text-success">$@factura.Total.ToString("N2")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2 mb-4">
            <button class="btn btn-secondary" @onclick="Volver">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </button>
            
            @{
                var estadoSriUpper = factura.EstadoSri?.ToUpperInvariant() ?? "";
                var estadoLower = factura.Estado?.ToLowerInvariant() ?? "";
                var estaGenerada = !factura.Firmada && string.IsNullOrWhiteSpace(factura.EstadoSri);
                var estaFirmada = factura.Firmada || estadoSriUpper == "FIRMADA";
                var estaAutorizada = estadoSriUpper == "AUTORIZADO";
                var tieneClaveAcceso = !string.IsNullOrWhiteSpace(factura.ClaveAcceso);
            }
            
            @if (estaGenerada)
            {
                <button class="btn btn-warning" @onclick="() => FirmarFactura(Id)">
                    <i class="fas fa-signature me-2"></i>Firmar
                </button>
            }
            else if (estaFirmada && !estaAutorizada)
            {
                <button class="btn btn-success" @onclick="() => EmitirSri(Id)">
                    <i class="fas fa-paper-plane me-2"></i>Emitir SRI
                </button>
                <button class="btn btn-outline-primary" @onclick="() => DescargarPDF(Id)">
                    <i class="fas fa-file-pdf me-2"></i>RIDE
                </button>
                <button class="btn btn-outline-info" @onclick="() => DescargarXML(Id)">
                    <i class="fas fa-file-code me-2"></i>XML
                </button>
                <button class="btn btn-outline-success" @onclick="() => EnviarPorEmail(Id)">
                    <i class="fas fa-envelope me-2"></i>Enviar por Correo
                </button>
            }
            else if (estaAutorizada)
            {
                <button class="btn btn-outline-primary" @onclick="() => DescargarPDF(Id)">
                    <i class="fas fa-file-pdf me-2"></i>RIDE
                </button>
                <button class="btn btn-outline-info" @onclick="() => DescargarXML(Id)">
                    <i class="fas fa-file-code me-2"></i>XML
                </button>
                <button class="btn btn-outline-success" @onclick="() => EnviarPorEmail(Id)">
                    <i class="fas fa-envelope me-2"></i>Enviar por Correo
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private FacturaConsultaDto? factura;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarFactura();
    }

    private async Task CargarFactura()
    {
        cargando = true;
        factura = await FacturaService.ConsultarFacturaAsync(Id);
        cargando = false;
        StateHasChanged();
    }

    private void Volver()
    {
        Navigation.NavigateTo("/facturas");
    }

    private async Task DescargarPDF(int facturaId)
    {
        try
        {
            var pdfBytes = await FacturaService.DescargarPDFAsync(facturaId);
            if (pdfBytes != null && pdfBytes.Length > 0)
            {
                await JS.InvokeVoidAsync("downloadFile", $"Factura_{facturaId}.pdf", Convert.ToBase64String(pdfBytes), "application/pdf");
                NotificationService.ShowSuccess("PDF descargado correctamente.");
            }
            else
            {
                NotificationService.ShowError("No se pudo generar el PDF.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error al descargar PDF: {ex.Message}");
        }
    }

    private async Task DescargarXML(int facturaId)
    {
        try
        {
            // Obtener el XML desde el backend
            var xmlResp = await Http.GetAsync($"api/facturas/{facturaId}/xml");
            if (xmlResp.IsSuccessStatusCode)
            {
                var xmlContent = await xmlResp.Content.ReadAsStringAsync();
                var xmlBytes = System.Text.Encoding.UTF8.GetBytes(xmlContent);
                await JS.InvokeVoidAsync("downloadFile", $"Factura_{facturaId}.xml", Convert.ToBase64String(xmlBytes), "application/xml");
                NotificationService.ShowSuccess("XML descargado correctamente.");
            }
            else
            {
                var error = await xmlResp.Content.ReadAsStringAsync();
                NotificationService.ShowError($"No se pudo obtener el XML: {error}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError($"Error al descargar XML: {ex.Message}");
        }
    }

    private async Task EnviarPorEmail(int facturaId)
    {
        NotificationService.ShowInfo("Enviando factura por correo...");
        var resultado = await FacturaService.EnviarFacturaPorEmailAsync(facturaId);
        if (resultado != null && resultado.Exito)
        {
            var mensaje = resultado.Mensaje ?? "Correo enviado correctamente al cliente.";
            NotificationService.ShowSuccess(mensaje);
        }
        else
        {
            var errorMsg = resultado?.Error ?? "No se pudo enviar el correo.";
            NotificationService.ShowError($"Error al enviar correo: {errorMsg}");
        }
    }

    private async Task FirmarFactura(int facturaId)
    {
        NotificationService.ShowInfo("Firmando factura...");
        var resultado = await FacturaService.FirmarFacturaAsync(facturaId);
        if (resultado != null && resultado.Exito)
        {
            var mensaje = $"Factura {resultado.Numero} firmada correctamente.";
            if (!string.IsNullOrEmpty(resultado.ClaveAcceso))
                mensaje += $"\nClave de Acceso: {resultado.ClaveAcceso}";
            NotificationService.ShowSuccess(mensaje);
            // Recargar la factura para actualizar el estado
            await CargarFactura();
        }
        else
        {
            var errorMsg = resultado?.Error ?? "No se pudo firmar la factura.";
            NotificationService.ShowError($"Error al firmar: {errorMsg}");
        }
    }

    private async Task EmitirSri(int facturaId)
    {
        NotificationService.ShowInfo("Emitiendo factura al SRI...");
        var resultado = await FacturaService.EmitirSriAsync(facturaId);
        if (resultado != null && string.IsNullOrEmpty(resultado.Error))
        {
            NotificationService.ShowSuccess($"Factura emitida correctamente al SRI. Estado: {resultado.EstadoSri}");
            // Recargar la factura para actualizar el estado
            await CargarFactura();
        }
        else
        {
            var errorMsg = resultado?.Error ?? "No se pudo emitir la factura al SRI.";
            NotificationService.ShowError($"Error al emitir: {errorMsg}");
        }
    }

    private string GetEstadoBadgeClass(string? estado, string? estadoSri = null) 
    {
        // Solo usar estado SRI
        if (!string.IsNullOrWhiteSpace(estadoSri))
        {
            return estadoSri.ToUpperInvariant() switch
            {
                "AUTORIZADO" => "bg-success",
                "RECIBIDA" => "bg-info",
                "FIRMADA" => "bg-primary",
                "NO AUTORIZADO" => "bg-danger",
                "RECHAZADO" => "bg-danger",
                "DEVUELTA" => "bg-warning text-dark",
                _ => "bg-secondary"
            };
        }
        
        // Si no hay EstadoSri, mostrar como pendiente
        return "bg-warning text-dark";
    }
    
    private string GetEstadoDisplay(string? estado, string? estadoSri = null)
    {
        // Solo usar estado SRI
        if (!string.IsNullOrWhiteSpace(estadoSri))
            return estadoSri;
        
        // Si no hay EstadoSri, mostrar como pendiente
        return "PENDIENTE";
    }

    private string GetEstadoIcon(string? estado, string? estadoSri = null)
    {
        // Solo usar estado SRI
        if (!string.IsNullOrWhiteSpace(estadoSri))
        {
            return estadoSri.ToUpperInvariant() switch
            {
                "AUTORIZADO" => "fa-check-circle",
                "RECIBIDA" => "fa-inbox",
                "FIRMADA" => "fa-signature",
                "NO AUTORIZADO" => "fa-times-circle",
                "RECHAZADO" => "fa-times-circle",
                "DEVUELTA" => "fa-undo",
                _ => "fa-clock"
            };
        }
        
        // Si no hay EstadoSri, mostrar icono de pendiente
        return "fa-clock";
    }

    private string GetEstadoAlertClass(string? estado, string? estadoSri = null)
    {
        // Solo usar estado SRI
        if (!string.IsNullOrWhiteSpace(estadoSri))
        {
            return estadoSri.ToUpperInvariant() switch
            {
                "AUTORIZADO" => "alert-success",
                "RECIBIDA" => "alert-info",
                "FIRMADA" => "alert-primary",
                "NO AUTORIZADO" => "alert-danger",
                "RECHAZADO" => "alert-danger",
                "DEVUELTA" => "alert-warning",
                _ => "alert-secondary"
            };
        }
        
        // Si no hay EstadoSri, mostrar como pendiente
        return "alert-warning";
    }
}