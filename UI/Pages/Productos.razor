@page "/productos"
@attribute [Authorize]
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using System.ComponentModel.DataAnnotations

<h3 class="mb-4"><i class="fa-solid fa-boxes-stacked me-2"></i>Gestión de Productos e Inventario</h3>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <button class="btn btn-primary mb-3" @onclick="MostrarFormularioNuevo">
            <i class="fa-solid fa-plus-circle"></i> Nuevo Producto
        </button>

        @if (mostrarFormulario)
        {
            <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-box-open me-2"></i>
                        @(productoEditando.Id == 0 ? "Registrar Nuevo Producto" : "Editar Producto")
                    </h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@productoEditando" OnValidSubmit="@GuardarProducto">
                        <DataAnnotationsValidator />

                        <div class="border-bottom pb-3 mb-3">
                            <h6 class="text-primary"><i class="fa-solid fa-info-circle me-2"></i>Información del Producto</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Código del Producto <span class="text-danger">*</span></label>
                                    <InputText @bind-Value="productoEditando.Codigo" class="form-control" placeholder="Ej: PROD-001" />
                                    <ValidationMessage For="@(() => productoEditando.Codigo)" class="text-danger small" />
                                </div>
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
                                    <InputText @bind-Value="productoEditando.Nombre" class="form-control" placeholder="Ej: Laptop HP Pavilion 15" />
                                    <ValidationMessage For="@(() => productoEditando.Nombre)" class="text-danger small" />
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Descripción</label>
                                    <InputTextArea @bind-Value="productoEditando.Descripcion" class="form-control" rows="2" placeholder="Descripción detallada del producto" />
                                </div>
                            </div>
                        </div>

                        <div class="border-bottom pb-3 mb-3">
                            <h6 class="text-success"><i class="fa-solid fa-truck-loading me-2"></i>Lotes de Compra / Inventario</h6>
                            <p class="text-muted small mb-3">
                                <i class="fa-solid fa-lightbulb me-1"></i>
                                Cada compra es un nuevo lote con su factura y costo.
                            </p>

                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Nº Lote / Factura <span class="text-danger">*</span></label>
                                            <input type="text" @bind="nuevoLote.NumeroLote" class="form-control" placeholder="FAC-001-2025" />
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Cantidad <span class="text-danger">*</span></label>
                                            <input type="number" @bind="nuevoLote.Cantidad" min="1" class="form-control" />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Precio Costo <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" @bind="nuevoLote.PrecioUnitario" step="0.01" min="0.01" class="form-control" />
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label d-block">&nbsp;</label>
                                            <button type="button" class="btn btn-success w-100" @onclick="AgregarLote">
                                                <i class="fa-solid fa-plus"></i> Agregar Lote
                                            </button>
                                        </div>
                                    </div>

                                    @if (nuevoLote.Cantidad > 0 && nuevoLote.PrecioUnitario > 0)
                                    {
                                        <div class="alert alert-info mt-2 mb-0">
                                            <i class="fa-solid fa-calculator me-2"></i>
                                            Subtotal: <strong class="text-success">$@((nuevoLote.Cantidad * nuevoLote.PrecioUnitario).ToString("N2"))</strong>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(mensajeValidacionLote))
                                    {
                                        <div class="alert alert-warning mt-2 mb-0">
                                            <i class="fa-solid fa-exclamation-triangle me-2"></i>@mensajeValidacionLote
                                        </div>
                                    }
                                </div>
                            </div>

                            @if (productoEditando.Lotes.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover table-bordered">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Nº Lote / Factura</th>
                                                <th class="text-end">Cantidad</th>
                                                <th class="text-end">Precio Costo</th>
                                                <th class="text-end">Valor Total</th>
                                                <th class="text-center">Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var lote in productoEditando.Lotes)
                                            {
                                                <tr>
                                                    <td><i class="fa-solid fa-file-invoice text-primary me-1"></i><strong>@lote.NumeroLote</strong></td>
                                                    <td class="text-end">@lote.Cantidad</td>
                                                    <td class="text-end">$@lote.PrecioUnitario.ToString("N2")</td>
                                                    <td class="text-end"><strong class="text-success">$@((lote.Cantidad * lote.PrecioUnitario).ToString("N2"))</strong></td>
                                                    <td class="text-center">
                                                        <button type="button" class="btn btn-sm btn-danger" @onclick="() => EliminarLote(lote)">
                                                            <i class="fa-solid fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="table-info">
                                            <tr class="fw-bold">
                                                <td>TOTALES</td>
                                                <td class="text-end">@productoEditando.Lotes.Sum(l => l.Cantidad)</td>
                                                <td class="text-end">-</td>
                                                <td class="text-end text-success">
                                                    $@productoEditando.Lotes.Sum(l => l.Cantidad * l.PrecioUnitario).ToString("N2")
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">Debes registrar al menos un lote de compra.</div>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(mensajeError))
                        {
                            <div class="alert alert-danger"><i class="fa-solid fa-exclamation-triangle me-2"></i>@mensajeError</div>
                        }
                        @if (!string.IsNullOrEmpty(mensajeExito))
                        {
                            <div class="alert alert-success"><i class="fa-solid fa-check-circle me-2"></i>@mensajeExito</div>
                        }

                        <div class="d-flex gap-2 mt-3">
                            <button type="submit" class="btn btn-success btn-lg" disabled="@(!productoEditando.Lotes.Any())">
                                <i class="fa-solid fa-save me-2"></i>
                                Guardar Producto @(productoEditando.Lotes.Any() ? $"({productoEditando.Lotes.Sum(l => l.Cantidad)} u.)" : "")
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" @onclick="CancelarEdicion">
                                <i class="fa-solid fa-times me-2"></i> Cancelar
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        @if (productos == null)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Cargando inventario...</p>
            </div>
        }
        else if (!productos.Any())
        {
            <div class="alert alert-info"><i class="fa-solid fa-info-circle"></i> No hay productos. Crea uno.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-success">
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th class="text-center">Lotes</th>
                            <th class="text-center">Stock Total</th>
                            <th class="text-end">Valor Inventario</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in productos)
                        {
                            var stockTotal = p.Lotes?.Sum(l => l.Cantidad) ?? 0;
                            var valorTotal = p.Lotes?.Sum(l => l.Cantidad * l.PrecioUnitario) ?? 0m;
                            <tr>
                                <td><span class="badge bg-dark">@p.Codigo</span></td>
                                <td><strong>@p.Nombre</strong></td>
                                <td>@p.Descripcion</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-info" @onclick="() => MostrarLotes(p)">
                                        <i class="fa-solid fa-eye"></i> @(p.Lotes?.Count ?? 0)
                                    </button>
                                </td>
                                <td class="text-center">
                                    <span class="badge @(stockTotal > 0 ? "bg-success" : "bg-danger") fs-6">
                                        @stockTotal
                                    </span>
                                </td>
                                <td class="text-end"><strong class="text-success">$@valorTotal.ToString("N2")</strong></td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm flex-nowrap" role="group" aria-label="Acciones">
                                        <button class="btn btn-warning" title="Editar" @onclick="() => EditarProducto(p)">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </button>
                                        <button class="btn btn-danger" title="Eliminar" @onclick="() => EliminarProducto(p.Id)">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-primary">
                        <tr class="fw-bold">
                            <td colspan="4" class="text-end">TOTALES:</td>
                            <td class="text-center">@productos.Sum(p => p.Lotes?.Sum(l => l.Cantidad) ?? 0)</td>
                            <td class="text-end text-success">$@productos.Sum(p => p.Lotes?.Sum(l => l.Cantidad * l.PrecioUnitario) ?? 0).ToString("N2")</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
    </div>
</div>

@if (mostrarModalLotes && productoSeleccionado is not null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fa-solid fa-layer-group me-2"></i>Historial de Lotes - @productoSeleccionado!.Nombre</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalLotes"></button>
                </div>
                <div class="modal-body">
                    @if (productoSeleccionado!.Lotes?.Any() == true)
                    {
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nº Lote / Factura</th>
                                    <th class="text-end">Cantidad</th>
                                    <th class="text-end">Precio Costo</th>
                                    <th class="text-end">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var l in productoSeleccionado!.Lotes!)
                                {
                                    <tr>
                                        <td><i class="fa-solid fa-file-invoice text-primary me-1"></i><strong>@l.NumeroLote</strong></td>
                                        <td class="text-end">@l.Cantidad</td>
                                        <td class="text-end">$@l.PrecioUnitario.ToString("N2")</td>
                                        <td class="text-end"><strong>$@((l.Cantidad * l.PrecioUnitario).ToString("N2"))</strong></td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-info">
                                <tr class="fw-bold">
                                    <td>TOTALES</td>
                                    <td class="text-end">@productoSeleccionado!.Lotes!.Sum(l => l.Cantidad)</td>
                                    <td class="text-end">-</td>
                                    <td class="text-end text-success">$@productoSeleccionado!.Lotes!.Sum(l => l.Cantidad * l.PrecioUnitario).ToString("N2")</td>
                                </tr>
                            </tfoot>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted mb-0">No hay lotes registrados para este producto.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalLotes">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Producto>? productos;
    private Producto productoEditando = new();
    private Lote nuevoLote = new();
    private bool mostrarFormulario;
    private bool mostrarModalLotes;
    private Producto? productoSeleccionado;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string mensajeValidacionLote = string.Empty;

    protected override async Task OnInitializedAsync() => await CargarProductos();

    private async Task CargarProductos()
    {
        try { productos = await Http.GetFromJsonAsync<List<Producto>>("api/productos"); }
        catch (Exception ex) { mensajeError = $"Error al cargar productos: {ex.Message}"; }
    }

    private void MostrarFormularioNuevo()
    {
        productoEditando = new();
        nuevoLote = new();
        mostrarFormulario = true;
        LimpiarMensajes();
    }

    private void EditarProducto(Producto p)
    {
        productoEditando = new Producto
        {
            Id = p.Id,
            Codigo = p.Codigo,
            Nombre = p.Nombre,
            Descripcion = p.Descripcion,
            Lotes = new List<Lote>(p.Lotes ?? new())
        };
        nuevoLote = new();
        mostrarFormulario = true;
        LimpiarMensajes();
    }

    private void AgregarLote()
    {
        mensajeValidacionLote = string.Empty;

        if (string.IsNullOrWhiteSpace(nuevoLote.NumeroLote)) { mensajeValidacionLote = "Ingrese el número de lote o factura."; return; }
        if (nuevoLote.Cantidad <= 0) { mensajeValidacionLote = "La cantidad debe ser mayor a 0."; return; }
        if (nuevoLote.PrecioUnitario <= 0) { mensajeValidacionLote = "El precio de costo debe ser mayor a 0."; return; }
        if (productoEditando.Lotes.Any(l => l.NumeroLote.Equals(nuevoLote.NumeroLote, StringComparison.OrdinalIgnoreCase))) { mensajeValidacionLote = "Ya existe un lote con ese número."; return; }

        productoEditando.Lotes.Add(new Lote
        {
            NumeroLote = nuevoLote.NumeroLote.Trim().ToUpper(),
            Cantidad = nuevoLote.Cantidad,
            PrecioUnitario = nuevoLote.PrecioUnitario
        });

        nuevoLote = new();
        mensajeExito = "Lote agregado. Puede agregar más lotes o guardar.";
    }

    private void EliminarLote(Lote lote)
    {
        productoEditando.Lotes.Remove(lote);
        mensajeExito = "Lote eliminado.";
    }

    private async Task GuardarProducto()
    {
        LimpiarMensajes();
        if (!productoEditando.Lotes.Any()) { mensajeError = "Debe agregar al menos un lote."; return; }

        try
        {
            HttpResponseMessage resp = productoEditando.Id == 0
                ? await Http.PostAsJsonAsync("api/productos", productoEditando)
                : await Http.PutAsJsonAsync($"api/productos/{productoEditando.Id}", productoEditando);

            if (resp.IsSuccessStatusCode)
            {
                mensajeExito = productoEditando.Id == 0 ? "Producto registrado." : "Producto actualizado.";
                await CargarProductos();
                await Task.Delay(800);
                CancelarEdicion();
            }
            else
            {
                var body = await resp.Content.ReadAsStringAsync();
                mensajeError = $"Error al guardar: {body}";
            }
        }
        catch (Exception ex) { mensajeError = $"Error al guardar: {ex.Message}"; }
    }

    private async Task EliminarProducto(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Eliminar este producto y sus lotes?"))
        {
            try
            {
                var resp = await Http.DeleteAsync($"api/productos/{id}");
                if (resp.IsSuccessStatusCode)
                { mensajeExito = "Producto eliminado."; await CargarProductos(); }
                else
                { mensajeError = "No se pudo eliminar."; }
            }
            catch (Exception ex) { mensajeError = $"Error: {ex.Message}"; }
        }
    }

    private void MostrarLotes(Producto p) { productoSeleccionado = p; mostrarModalLotes = true; }
    private void CerrarModalLotes() { mostrarModalLotes = false; productoSeleccionado = null; }

    private void CancelarEdicion() { mostrarFormulario = false; productoEditando = new(); nuevoLote = new(); LimpiarMensajes(); }
    private void LimpiarMensajes() { mensajeError = mensajeExito = mensajeValidacionLote = string.Empty; }

    public class Producto
    {
        public int Id { get; set; }
        [Required(ErrorMessage = "El código es requerido"), StringLength(50)]
        public string Codigo { get; set; } = string.Empty;
        [Required(ErrorMessage = "El nombre es requerido"), StringLength(200, MinimumLength = 3)]
        public string Nombre { get; set; } = string.Empty;
        public string? Descripcion { get; set; }
        public List<Lote> Lotes { get; set; } = new();
    }
    public class Lote
    {
        public int Id { get; set; }
        public string NumeroLote { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public decimal PrecioUnitario { get; set; }
        public int ProductoId { get; set; }
    }
}
