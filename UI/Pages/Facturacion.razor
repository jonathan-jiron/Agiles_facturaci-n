@page "/facturacion"
@attribute [Authorize]
@layout MainLayout
@inject FacturaService FacturaService
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject HttpClient Http
@inject FacturaEventService FacturaEventService

@using Application.DTOs

<PageTitle>Nueva Factura Electrónica</PageTitle>

<div class="content-area">
    <h2 class="fw-bold text-primary mb-4">
        <i class="fas fa-file-invoice me-2"></i>
        Nueva Factura Electrónica
    </h2>
    <EditForm Model="@facturaForm" OnValidSubmit="GuardarFactura">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Datos de la Factura -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Datos de la Factura</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Fecha de Emisión <span class="text-danger">*</span></label>
                        <InputDate @bind-Value="facturaForm.FechaEmision" class="form-control" @onchange="OnFechaEmisionChanged" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Establecimiento <span class="text-danger">*</span></label>
                        <input class="form-control" @bind="facturaForm.Establecimiento" required maxlength="3" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Punto de Emisión <span class="text-danger">*</span></label>
                        <input class="form-control" @bind="facturaForm.PuntoEmision" required maxlength="3" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Vendedor</label>
                        <input class="form-control" @bind="facturaForm.Vendedor" maxlength="50" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Número de Documento <span class="text-danger">*</span></label>
                        <input class="form-control" @bind="facturaForm.NumeroDocumento" required maxlength="15" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Cliente -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Información del Cliente</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Cliente <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input class="form-control" value="@clienteActual?.NombreRazonSocial" readonly placeholder="Seleccione un cliente..." />
                            <button class="btn btn-outline-secondary" type="button" @onclick="MostrarSelectorClientes">
                                <i class="fa fa-search"></i>
                            </button>
                            @if (clienteActual != null)
                            {
                                <button class="btn btn-outline-primary" type="button" @onclick="AbrirModalEditarCliente">
                                    <i class="fa fa-edit"></i>
                                </button>
                            }
                        </div>
                    </div>
                </div>
                @if (clienteActual != null)
                {
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">Cédula/RUC/Pasaporte</label>
                            <input class="form-control" value="@clienteActual.Identificacion" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Dirección</label>
                            <input class="form-control" value="@clienteActual.Direccion" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Teléfono</label>
                            <input class="form-control" value="@clienteActual.Telefono" readonly />
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label class="form-label">Email</label>
                            <input class="form-control" value="@clienteActual.Email" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tipo Identificación</label>
                            <input class="form-control" value="@clienteActual.TipoIdentificacion" readonly />
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Productos -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Productos</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Bodega</label>
                    <input class="form-control" value="Bodega Principal" readonly />
                </div>
                <div class="table-responsive" style="min-height:350px;">
                    <table class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr table-bordered>
                                <th style="width:40px;"></th>
                                <th class="text-end" style="width:80px;">Cant.</th>
                                <th>Producto</th>
                                <th>Unidad</th>
                                <th class="text-end" style="width:120px;">Precio U.</th>
                                <th class="text-end" style="width:80px;">Desc. %</th>
                                <th class="text-end" style="width:100px;">Desc. $</th>
                                <th class="text-end" style="width:120px;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < detalles.Count; i++)
                            {
                                var index = i;
                                <tr>
                                    <td>
                                        <button class="btn btn-sm btn-danger" type="button" @onclick="@(() => EliminarProducto(index))">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-end"
                                               @bind="detalles[index].Cantidad" min="1"
                                               @oninput="(e) => { detalles[index].RecalcularTotales(); }" />
                                    </td>
                                    <td style="position:relative;">
                                        <input class="form-control form-control-sm"
                                               placeholder="Buscar producto..."
                                               value="@detalles[index].ProductoNombre"
                                               @oninput="async e => await BuscarProducto(index, e.Value?.ToString())"
                                               @onblur="() => OnProductoSeleccionadoFila(index, detalles[index].ProductoSeleccionado)" />
                                        @if (detalles[index].ResultadosBusqueda?.Any() == true)
                                        {
                                            <div class="dropdown-menu show producto-dropdown">
                                                @foreach (var prod in detalles[index].ResultadosBusqueda)
                                                {
                                                    <button type="button" class="dropdown-item"
                                                            @onclick="() => SeleccionarProductoFila(index, prod)">
                                                        @prod.Nombre - @prod.PrecioVenta.ToString("C") (Stock: @prod.Stock)
                                                    </button>
                                                }
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        <input class="form-control form-control-sm" value="@detalles[index].Unidad" readonly />
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-end"
                                               @bind="detalles[index].PrecioUnitario" min="0" step="0.01"
                                               @oninput="(e) => { detalles[index].RecalcularTotales(); }" />
                                    </td>
                                    <td>
                                        <input type="number" class="form-control form-control-sm text-end"
                                               @bind="detalles[index].DescuentoPorcentaje" min="0" max="100" step="0.01"
                                               @oninput="(e) => { detalles[index].RecalcularTotales(); }" />
                                    </td>
                                    <td class="text-end">
                                        $@detalles[index].Descuento.ToString("N2")
                                    </td>
                                    <td class="text-end">
                                        $@detalles[index].Subtotal.ToString("N2")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-primary mt-2" type="button" @onclick="AgregarDetalle">
                    <i class="fas fa-plus"></i> Agregar detalle
                </button>
            </div>
        </div>

        <!-- Formas de Pago -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Formas de Pago</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Forma de Pago <span class="text-danger">*</span></label>
                        <select class="form-select" @bind="facturaForm.FormaPago" required>
                            <option value="">Seleccione...</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia Bancaria</option>
                            <option value="TarjetaCredito">Tarjeta de Crédito</option>
                            <option value="TarjetaDebito">Tarjeta de Débito</option>
                        </select>
                    </div>
                    @if (facturaForm.FormaPago == "Transferencia")
                    {
                        <div class="col-md-6">
                            <label class="form-label">N° Comprobante de Transferencia <span class="text-danger">*</span></label>
                            <input class="form-control" @bind="facturaForm.NumeroComprobante" maxlength="30" required />
                            <label class="form-label mt-2">Pagado:</label>
                            <input class="form-control" type="number" min="0" max="@total" @bind="pagado" @bind:event="oninput" />
                        </div>
                    }
                    else
                    {
                        <div class="col-md-6">
                            <label class="form-label">Pagado:</label>
                            <input class="form-control" type="number" min="0" max="@total" @bind="pagado" @bind:event="oninput" />
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Descripción / Observaciones -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Descripción / Observaciones</h5>
            </div>
            <div class="card-body">
                <InputTextArea @bind-Value="facturaForm.Observaciones" class="form-control" rows="2" placeholder="Ingrese una nota o descripción..." />
            </div>
        </div>

        <!-- Resumen de Factura adaptado (sin pagado) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen de Factura</h5>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-2">
                    <div class="col-6 text-end">Subtotal 12%:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control" value="@subtotal.ToString("N2")" readonly />
                        </div>
                    </div>
                    <div class="col-6 text-end">Subtotal 0%:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control" value="0.00" readonly />
                        </div>
                    </div>
                    <div class="col-6 text-end">Descuento:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control" value="@descuentoTotal.ToString("N2")" readonly />
                        </div>
                    </div>
                    <div class="col-6 text-end">IVA:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control" value="@iva.ToString("N2")" readonly />
                        </div>
                    </div>
                    <div class="col-6 text-end">ICE:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control" value="@iceTotal.ToString("N2")" readonly />
                        </div>
                    </div>
                    <div class="col-6 text-end">Total:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control fw-bold" value="@total.ToString("N2")" readonly />
                        </div>
                    </div>
                    <div class="col-6 text-end">Saldo:</div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input class="form-control fw-bold" value="@saldo.ToString("N2")" readonly />
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2 mt-3">
                    @if (facturaGuardadaId == null)
                    {
                        <button class="btn btn-primary btn-lg" type="button" @onclick="GuardarFactura"
                                disabled="@(saldo != 0)">
                            <i class="fas fa-save me-2"></i>Guardar Factura
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-success text-center fw-bold">
                            <i class="fas fa-check-circle me-2"></i>Factura guardada
                        </div>
                    }
                    <button class="btn btn-outline-secondary" type="button" @onclick="LimpiarFormulario">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorGeneral))
        {
            <div class="alert alert-danger mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>@errorGeneral
            </div>
        }
        @if (!string.IsNullOrEmpty(clienteValidationMessage))
        {
            <div class="alert alert-danger mt-3">@clienteValidationMessage</div>
        }
    </EditForm>

    <!-- Modal de selección de cliente -->
    @if (mostrarSelectorClientes)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="fa fa-search me-2"></i>Seleccionar Cliente</h5>
                        <button type="button" class="btn-close" @onclick="CerrarSelectorClientes"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input class="form-control" placeholder="Filtrar por RUC o nombre..." @bind="filtroCliente" @bind:event="oninput" />
                        </div>
                        <div style="max-height: 350px; overflow-y: auto;">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>RUC</th>
                                        <th>Nombre Comercial</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var cliente in clientesFiltrados)
                                    {
                                        <tr>
                                            <td>@cliente.Identificacion</td>
                                            <td>@cliente.NombreRazonSocial</td>
                                            <td>
                                                <button class="btn btn-sm btn-success" @onclick="() => SeleccionarCliente(cliente)">
                                                    <i class="fa fa-check"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal de edición de cliente -->
    @if (mostrarModalEditarCliente)
    {
        <div class="modal-backdrop"></div>
        <div class="modal-edicion modal-edicion-grande">
            <h4 class="mb-3">Editar Cliente</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label>Nombre/Razón Social:</label>
                    <input class="form-control" @bind="clienteActual.NombreRazonSocial" maxlength="100" />
                </div>
                <div class="col-md-6">
                    <label>Tipo Identificación:</label>
                    <select class="form-select" @bind="clienteActual.TipoIdentificacion">
                        <option value="">Seleccione...</option>
                        <option value="RUC">RUC</option>
                        <option value="Cédula">Cédula</option>
                        <option value="Pasaporte">Pasaporte</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label>Cédula/RUC/Pasaporte:</label>
                    <input class="form-control" @bind="clienteActual.Identificacion" maxlength="13" />
                </div>
                <div class="col-md-6">
                    <label>Dirección:</label>
                    <input class="form-control" @bind="clienteActual.Direccion" maxlength="120" />
                </div>
                <div class="col-md-6">
                    <label>Teléfono:</label>
                    <input class="form-control" @bind="clienteActual.Telefono" maxlength="20" />
                </div>
                <div class="col-md-6">
                    <label>Email:</label>
                    <input class="form-control" @bind="clienteActual.Email" type="email" maxlength="80" />
                </div>
            </div>
            @if (!string.IsNullOrEmpty(clienteValidationMessage))
            {
                <div class="alert alert-danger mt-3">@clienteValidationMessage</div>
            }
            <div class="d-flex justify-content-end mt-4">
                <button class="btn btn-secondary me-2" @onclick="CancelarEdicionCliente">Cancelar</button>
                <button class="btn btn-primary" @onclick="GuardarEdicionCliente">Guardar</button>
            </div>
        </div>
    }

    @if (facturaGuardadaId != null)
    {
        <div class="text-end mb-3">
            <button class="btn btn-success" @onclick="() => FirmarFactura(facturaGuardadaId.Value)">
                <i class="fas fa-signature me-2"></i>Firmar Factura
            </button>
        </div>
    }
</div>

@code {
    // Variables y modelos
    private FacturaForm facturaForm = new();
    private List<Cliente> clientes = new();
    private Cliente? clienteActual;
    private List<DetalleItem> detalles = new();
    private string errorGeneral = "";
    private bool mostrarSelectorClientes = false;
    private string filtroCliente = "";
    private bool mostrarModalEditarCliente = false;
    private string clienteValidationMessage = "";
    private bool mostrarResumen = false;
    private int? facturaGuardadaId = null;
    private string numeroGenerado = "";

    private List<Cliente> clientesFiltrados => string.IsNullOrWhiteSpace(filtroCliente)
        ? clientes
        : clientes.Where(c =>
            (c.Identificacion?.Contains(filtroCliente, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (c.NombreRazonSocial?.Contains(filtroCliente, StringComparison.OrdinalIgnoreCase) ?? false)
        ).ToList();

    private decimal subtotal => detalles.Sum(d => d.Subtotal);
    private decimal descuentoTotal => detalles.Sum(d => d.Descuento);
    private decimal iva => detalles.Sum(d => d.IvaLinea);
    private decimal iceTotal => detalles.Sum(d => d.IceLinea);
    private decimal irbpnrTotal => detalles.Sum(d => d.IrbpnrLinea);
    private decimal total => subtotal - descuentoTotal + iva + iceTotal + irbpnrTotal;
    private decimal pagado = 0;
    private decimal saldo => Math.Max(0, total - pagado);

    protected override async Task OnInitializedAsync()
    {
        clientes = await Http.GetFromJsonAsync<List<Cliente>>("api/clientes") ?? new();
        facturaForm.FechaEmision = DateTime.Now;
        facturaForm.Establecimiento = "001";
        facturaForm.PuntoEmision = "001";
        facturaForm.Vendedor = "JEAN REDROBAN";
        facturaForm.NumeroDocumento = await ObtenerSecuenciaFacturaAsync();
        if (detalles.Count == 0)
            AgregarDetalle();
    }

    // Método para obtener la secuencia del número de documento
    private async Task<string> ObtenerSecuenciaFacturaAsync()
    {
        var fecha = facturaForm.FechaEmision.ToString("yyyy-MM-dd");
        var secuencia = await Http.GetStringAsync($"api/facturas/secuencia?fecha={fecha}");
        return secuencia ?? $"{DateTime.Now:yyyyMMdd}-00001";
    }

    private void AgregarDetalle()
    {
        detalles.Add(new DetalleItem
        {
            Cantidad = 1,
            PrecioUnitario = 0,
            Descuento = 0,
            ProductoNombre = "",
            ProductoId = 0
        });
    }

    private void EliminarProducto(int index)
    {
        if (index >= 0 && index < detalles.Count)
        {
            detalles.RemoveAt(index);
            StateHasChanged();
        }
    }

    private bool PuedeGuardarFactura()
    {
        // Validaciones SRI Ecuador
        if (facturaForm.FechaEmision == default) return false;
        if (string.IsNullOrWhiteSpace(facturaForm.Establecimiento) || facturaForm.Establecimiento.Length != 3) return false;
        if (string.IsNullOrWhiteSpace(facturaForm.PuntoEmision) || facturaForm.PuntoEmision.Length != 3) return false;
        if (string.IsNullOrWhiteSpace(facturaForm.NumeroDocumento)) return false;
        if (clienteActual == null) return false;
        if (string.IsNullOrWhiteSpace(clienteActual.NombreRazonSocial)) return false;
        if (string.IsNullOrWhiteSpace(clienteActual.TipoIdentificacion)) return false;
        if (string.IsNullOrWhiteSpace(clienteActual.Identificacion)) return false;
        if (string.IsNullOrWhiteSpace(clienteActual.Direccion)) return false;
        if (string.IsNullOrWhiteSpace(clienteActual.Email)) return false;
        if (string.IsNullOrWhiteSpace(facturaForm.FormaPago)) return false;
        if (facturaForm.FormaPago == "Transferencia" && string.IsNullOrWhiteSpace(facturaForm.NumeroComprobante)) return false;
        if (!detalles.Any()) return false;
        foreach (var d in detalles)
        {
            if (d.ProductoId <= 0 || string.IsNullOrWhiteSpace(d.ProductoNombre)) return false;
            if (d.Cantidad <= 0) return false;
            if (d.PrecioUnitario <= 0) return false;
        }
        return true;
    }

    private async Task GuardarFactura()
    {
        errorGeneral = "";
        clienteValidationMessage = "";

        if (!PuedeGuardarFactura())
        {
            errorGeneral = "Verifique todos los campos y detalles antes de guardar la factura.";
            NotificationService.ShowError(errorGeneral);
            return;
        }

        // Validaciones adicionales de cliente
        if (clienteActual?.TipoIdentificacion == "RUC")
        {
            if (clienteActual.Identificacion.Length != 13 || !clienteActual.Identificacion.EndsWith("001"))
            {
                clienteValidationMessage = "El RUC debe tener 13 dígitos y terminar en '001'.";
                return;
            }
            if (!clienteActual.Identificacion.All(char.IsDigit))
            {
                clienteValidationMessage = "El RUC solo debe contener números.";
                return;
            }
        }
        else if (clienteActual?.TipoIdentificacion == "Cédula")
        {
            if (clienteActual.Identificacion.Length != 10 || !clienteActual.Identificacion.All(char.IsDigit))
            {
                clienteValidationMessage = "La cédula debe tener 10 dígitos numéricos.";
                return;
            }
        }
        else if (clienteActual?.TipoIdentificacion == "Pasaporte")
        {
            if (clienteActual.Identificacion.Length < 6 || clienteActual.Identificacion.Length > 15)
            {
                clienteValidationMessage = "El pasaporte debe tener entre 6 y 15 caracteres.";
                return;
            }
            if (!clienteActual.Identificacion.All(c => char.IsLetterOrDigit(c)))
            {
                clienteValidationMessage = "El pasaporte solo debe contener letras y números.";
                return;
            }
        }

        if (string.IsNullOrWhiteSpace(clienteActual?.Email) || !clienteActual.Email.Contains("@") || !clienteActual.Email.Contains("."))
        {
            clienteValidationMessage = "El correo electrónico no es válido.";
            return;
        }

        try
        {
            var facturaDto = new Application.DTOs.FacturaCreateDto
            {
                ClienteId = clienteActual.Id,
                Fecha = facturaForm.FechaEmision,
                Establecimiento = facturaForm.Establecimiento,
                PuntoEmision = facturaForm.PuntoEmision,
                FormaPago = facturaForm.FormaPago,
                NumeroComprobante = facturaForm.NumeroComprobante,
                Observaciones = facturaForm.Observaciones,
                Detalles = detalles.Select(d => new Application.DTOs.DetalleFacturaCreateDto
                {
                    ProductoId = d.ProductoId,
                    Cantidad = d.Cantidad,
                    PrecioUnitario = d.PrecioUnitario,
                    Descuento = d.Descuento,
                    IvaLinea = d.IvaLinea,
                    IceLinea = d.IceLinea,
                    IrbpnrLinea = d.IrbpnrLinea,
                    LoteId = 0
                }).ToList()
            };

            var resultado = await FacturaService.CrearFacturaAsync(facturaDto);

            if (resultado != null)
            {
                numeroGenerado = resultado.Numero; // <-- Guarda el número generado
                NotificationService.ShowSuccess($"Factura guardada correctamente. Número: {numeroGenerado}");
                FacturaEventService.NotificarFacturaGuardada();
                Navigation.NavigateTo("/facturas");
            }
            else
            {
                NotificationService.ShowError("No se pudo guardar la factura.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.ShowError("Error al guardar la factura: " + ex.Message);
        }
    }

    private async Task FirmarFactura(int facturaId)
    {
        NotificationService.ShowInfo("Firmando factura...");
        var resp = await FacturaService.FirmarFacturaAsync(facturaId);
        if (resp)
        {
            NotificationService.ShowSuccess("Factura firmada correctamente.");
            await CargarFacturas();
        }
        else
        {
            NotificationService.ShowError("No se pudo firmar la factura.");
        }
    }

    private void LimpiarFormulario()
    {
        facturaForm = new FacturaForm { FechaEmision = DateTime.Now };
        clienteActual = null;
        detalles.Clear();
        errorGeneral = "";
        clienteValidationMessage = "";
        mostrarResumen = false;
        NotificationService.ShowInfo("Formulario limpiado");
        AgregarDetalle();
    }

    private void MostrarSelectorClientes() => mostrarSelectorClientes = true;
    private void CerrarSelectorClientes() => mostrarSelectorClientes = false;

    private void SeleccionarCliente(Cliente cliente)
    {
        clienteActual = cliente;
        facturaForm.ClienteId = cliente.Id;
        mostrarSelectorClientes = false;
    }

    private async Task BuscarProducto(int index, string? texto)
    {
        if (index < 0 || index >= detalles.Count)
            return;

        if (string.IsNullOrWhiteSpace(texto))
        {
            detalles[index].ResultadosBusqueda = new List<ProductoSelector.ProductoDto>();
            return;
        }
        var productos = await Http.GetFromJsonAsync<List<ProductoSelector.ProductoDto>>($"api/productos/buscar?query={texto}");
        detalles[index].ResultadosBusqueda = productos ?? new List<ProductoSelector.ProductoDto>();
    }

    private void SeleccionarProductoFila(int index, ProductoSelector.ProductoDto producto)
    {
        if (index < 0 || index >= detalles.Count)
            return;

        detalles[index].ProductoId = producto.Id;
        detalles[index].ProductoNombre = producto.Nombre;
        detalles[index].PrecioUnitario = producto.PrecioVenta;
        detalles[index].Unidad = "Unidad";
        detalles[index].Stock = producto.Stock;
        detalles[index].ResultadosBusqueda = new List<ProductoSelector.ProductoDto>();
        detalles[index].ProductoSeleccionado = producto;
        detalles[index].TieneIva = producto.TieneIva;
        detalles[index].RecalcularTotales();
    }

    private void OnProductoSeleccionadoFila(int index, ProductoSelector.ProductoDto? producto)
    {
        if (index < 0 || index >= detalles.Count)
            return;

        if (producto != null)
        {
            detalles[index].ProductoId = producto.Id;
            detalles[index].ProductoNombre = producto.Nombre;
            detalles[index].PrecioUnitario = producto.PrecioVenta;
            detalles[index].RecalcularTotales();
        }
    }

    private void AbrirModalEditarCliente()
    {
        clienteValidationMessage = "";
        // Normaliza el valor para que coincida con el select
        if (clienteActual != null)
        {
            if (clienteActual.TipoIdentificacion?.ToUpper() == "RUC")
                clienteActual.TipoIdentificacion = "RUC";
            else if (clienteActual.TipoIdentificacion?.ToUpper() == "CEDULA")
                clienteActual.TipoIdentificacion = "Cédula";
            else if (clienteActual.TipoIdentificacion?.ToUpper() == "PASAPORTE")
                clienteActual.TipoIdentificacion = "Pasaporte";
        }
        mostrarModalEditarCliente = true;
    }

    private void CancelarEdicionCliente()
    {
        mostrarModalEditarCliente = false;
        clienteValidationMessage = "";
    }

    private async Task GuardarEdicionCliente()
    {
        clienteValidationMessage = "";

        if (clienteActual == null ||
            string.IsNullOrWhiteSpace(clienteActual.NombreRazonSocial) ||
            string.IsNullOrWhiteSpace(clienteActual.TipoIdentificacion) ||
            string.IsNullOrWhiteSpace(clienteActual.Identificacion) ||
            string.IsNullOrWhiteSpace(clienteActual.Email))
        {
            clienteValidationMessage = "Complete todos los campos obligatorios.";
            return;
        }

        // Validación según tipo de identificación
        if (clienteActual.TipoIdentificacion == "RUC")
        {
            if (clienteActual.Identificacion.Length != 13 || !clienteActual.Identificacion.EndsWith("001"))
            {
                clienteValidationMessage = "El RUC debe tener 13 dígitos y terminar en '001'.";
                return;
            }
            if (!clienteActual.Identificacion.All(char.IsDigit))
            {
                clienteValidationMessage = "El RUC solo debe contener números.";
                return;
            }
        }
        else if (clienteActual.TipoIdentificacion == "Cédula")
        {
            if (clienteActual.Identificacion.Length != 10 || !clienteActual.Identificacion.All(char.IsDigit))
            {
                clienteValidationMessage = "La cédula debe tener 10 dígitos numéricos.";
                return;
            }
        }
        else if (clienteActual.TipoIdentificacion == "Pasaporte")
        {
            if (clienteActual.Identificacion.Length < 6 || clienteActual.Identificacion.Length > 15)
            {
                clienteValidationMessage = "El pasaporte debe tener entre 6 y 15 caracteres.";
                return;
            }
            if (!clienteActual.Identificacion.All(c => char.IsLetterOrDigit(c)))
            {
                clienteValidationMessage = "El pasaporte solo debe contener letras y números.";
                return;
            }
        }

        if (!clienteActual.Email.Contains("@") || !clienteActual.Email.Contains("."))
        {
            clienteValidationMessage = "El correo electrónico no es válido.";
            return;
        }

        try
        {
            var response = await Http.PutAsJsonAsync($"api/clientes/{clienteActual.Id}", clienteActual);
            if (response.IsSuccessStatusCode)
            {
                var idx = clientes.FindIndex(c => c.Id == clienteActual.Id);
                if (idx >= 0) clientes[idx] = clienteActual;
                mostrarModalEditarCliente = false;
                NotificationService.ShowSuccess("Cliente actualizado correctamente.");
            }
            else
            {
                clienteValidationMessage = "Error al actualizar el cliente.";
            }
        }
        catch (Exception ex)
        {
            clienteValidationMessage = $"Error: {ex.Message}";
        }
    }

    // Modelos internos
    private class FacturaForm
    {
        public int ClienteId { get; set; }
        public DateTime FechaEmision { get; set; } = DateTime.Now;
        public string TipoDocumento { get; set; } = "Factura";
        public string Establecimiento { get; set; } = "";
        public string PuntoEmision { get; set; } = "";
        public string NumeroDocumento { get; set; } = "";
        public string Vendedor { get; set; } = "";
        public string FormaPago { get; set; } = "";
        public string NumeroComprobante { get; set; } = "";
        public string Observaciones { get; set; } = "";
    }

    private class Cliente
    {
        public int Id { get; set; }
        public string NombreRazonSocial { get; set; } = "";
        public string Identificacion { get; set; } = "";
        public string Direccion { get; set; } = "";
        public string Telefono { get; set; } = "";
        public string Email { get; set; } = "";
        public string TipoIdentificacion { get; set; } = "";
        public string TipoCliente { get; set; } = "";
    }

    private class DetalleItem
    {
        public int ProductoId { get; set; }
        public string ProductoNombre { get; set; } = "";
        public int Cantidad { get; set; }
        public decimal PrecioUnitario { get; set; }
        public decimal DescuentoPorcentaje { get; set; }
        public decimal Descuento { get; set; }
        public decimal Subtotal { get; set; }
        public decimal IvaLinea { get; set; }
        public decimal TotalLinea { get; set; }
        public decimal IceLinea { get; set; }
        public decimal IrbpnrLinea { get; set; }
        public List<ProductoSelector.ProductoDto> ResultadosBusqueda { get; set; } = new();
        public ProductoSelector.ProductoDto? ProductoSeleccionado { get; set; }
        public string Unidad { get; set; } = "Unidad";
        public int Stock { get; set; }
        public bool TieneIva { get; set; }

        public void RecalcularTotales()
        {
            Descuento = Math.Round((PrecioUnitario * Cantidad) * (DescuentoPorcentaje / 100m), 2);
            Subtotal = (PrecioUnitario * Cantidad) - Descuento;
            IvaLinea = TieneIva ? Math.Round(Subtotal * 0.15m, 2) : 0; // 15% si tiene IVA
            IceLinea = 0;
            IrbpnrLinea = 0;
            TotalLinea = Subtotal + IvaLinea + IceLinea + IrbpnrLinea;
        }
    }

    private async Task OnFechaEmisionChanged(ChangeEventArgs e)
    {
        if (e.Value is string fechaStr && DateTime.TryParse(fechaStr, out var fecha))
            facturaForm.FechaEmision = fecha;
        facturaForm.NumeroDocumento = await ObtenerSecuenciaFacturaAsync();
    }
    private async Task CargarFacturas()
    {
        Navigation.NavigateTo("/facturas", true);
    }
}
