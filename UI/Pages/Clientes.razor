@page "/clientes"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions

<h3 class="mb-4"><i class="fa-solid fa-users me-2"></i>Gestión de Clientes</h3>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
        <button class="btn btn-primary mb-3" @onclick="MostrarFormularioNuevo">
            <i class="fa-solid fa-user-plus"></i> Nuevo Cliente
        </button>

        @if (mostrarFormulario)
        {
            <div class="card border-primary mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-id-card me-2"></i>
                        @(clienteEditando.Id == 0 ? "Registrar Nuevo Cliente" : "Editar Cliente")
                    </h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@clienteEditando" OnValidSubmit="@GuardarCliente">
                        <DataAnnotationsValidator />
                        
                        <!-- Sección: Identificación -->
                        <div class="border-bottom pb-3 mb-3">
                            <h6 class="text-primary">
                                <i class="fa-solid fa-fingerprint me-2"></i>
                                Identificación del Cliente
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Tipo de Identificación <span class="text-danger">*</span>
                                    </label>
                                    <InputSelect @bind-Value="clienteEditando.TipoIdentificacion" class="form-select">
                                        <option value="">Seleccione...</option>
                                        <option value="CEDULA">Cédula (10 dígitos)</option>
                                        <option value="RUC">RUC (13 dígitos)</option>
                                        <option value="PASAPORTE">Pasaporte</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => clienteEditando.TipoIdentificacion)" class="text-danger small" />
                                </div>
                                
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">
                                        Número de Identificación <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="clienteEditando.CedulaRuc" class="form-control" 
                                               placeholder="@GetPlaceholderIdentificacion()" 
                                               maxlength="13" />
                                    <ValidationMessage For="@(() => clienteEditando.CedulaRuc)" class="text-danger small" />
                                    @if (!string.IsNullOrEmpty(mensajeValidacionCedula))
                                    {
                                        <small class="text-danger d-block mt-1">
                                            <i class="fa-solid fa-exclamation-circle me-1"></i>@mensajeValidacionCedula
                                        </small>
                                    }
                                    <small class="text-muted">
                                        <i class="fa-solid fa-info-circle me-1"></i>
                                        @GetInfoIdentificacion()
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Datos Personales/Empresa -->
                        <div class="border-bottom pb-3 mb-3">
                            <h6 class="text-primary">
                                <i class="fa-solid fa-user me-2"></i>
                                Datos del Cliente
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">
                                        @(clienteEditando.TipoIdentificacion == "RUC" ? "Razón Social" : "Nombre Completo") 
                                        <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="clienteEditando.Nombre" class="form-control" 
                                               placeholder="@(clienteEditando.TipoIdentificacion == "RUC" ? "Ej: EMPRESA XYZ S.A." : "Ej: Juan Alberto Pérez García")" />
                                    <ValidationMessage For="@(() => clienteEditando.Nombre)" class="text-danger small" />
                                    <small class="text-muted">
                                        <i class="fa-solid fa-info-circle me-1"></i>
                                        Debe coincidir con el documento de identificación
                                    </small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">
                                        Dirección <span class="text-danger">*</span>
                                    </label>
                                    <InputText @bind-Value="clienteEditando.Direccion" class="form-control" 
                                               placeholder="Calle principal y secundaria, número, ciudad" />
                                    <ValidationMessage For="@(() => clienteEditando.Direccion)" class="text-danger small" />
                                    <small class="text-muted">
                                        <i class="fa-solid fa-map-marker-alt me-1"></i>
                                        Dirección completa requerida para facturación electrónica
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Contacto -->
                        <div class="pb-3 mb-3">
                            <h6 class="text-primary">
                                <i class="fa-solid fa-address-book me-2"></i>
                                Información de Contacto
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Correo Electrónico <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                                        <InputText @bind-Value="clienteEditando.Correo" class="form-control" 
                                                   type="email" placeholder="cliente@ejemplo.com" />
                                    </div>
                                    <ValidationMessage For="@(() => clienteEditando.Correo)" class="text-danger small" />
                                    <small class="text-muted">
                                        <i class="fa-solid fa-paper-plane me-1"></i>
                                        Se enviará la factura electrónica a este correo
                                    </small>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        Teléfono <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fa-solid fa-phone"></i></span>
                                        <InputText @bind-Value="clienteEditando.Telefono" class="form-control" 
                                                   placeholder="0999999999" maxlength="10" />
                                    </div>
                                    <ValidationMessage For="@(() => clienteEditando.Telefono)" class="text-danger small" />
                                    @if (!string.IsNullOrEmpty(mensajeValidacionTelefono))
                                    {
                                        <small class="text-danger d-block mt-1">
                                            <i class="fa-solid fa-exclamation-circle me-1"></i>@mensajeValidacionTelefono
                                        </small>
                                    }
                                    <small class="text-muted">10 dígitos (celular o convencional)</small>
                                </div>
                            </div>
                        </div>

                        <!-- Mensajes -->
                        @if (!string.IsNullOrEmpty(mensajeError))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                <strong>Error:</strong> @mensajeError
                                <button type="button" class="btn-close" @onclick="() => mensajeError = string.Empty"></button>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(mensajeExito))
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fa-solid fa-check-circle me-2"></i>
                                <strong>Éxito:</strong> @mensajeExito
                                <button type="button" class="btn-close" @onclick="() => mensajeExito = string.Empty"></button>
                            </div>
                        }

                        <!-- Botones -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fa-solid fa-save me-2"></i>
                                Guardar Cliente
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg" @onclick="CancelarEdicion">
                                <i class="fa-solid fa-times me-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }

        <!-- Tabla de Clientes -->
        @if (clientes == null)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando clientes...</p>
            </div>
        }
        else if (!clientes.Any())
        {
            <div class="alert alert-info">
                <i class="fa-solid fa-info-circle"></i> No hay clientes registrados. Haz clic en "Nuevo Cliente" para agregar uno.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle">
                    <thead class="table-primary">
                        <tr>
                            <th>Tipo ID</th>
                            <th>Identificación</th>
                            <th>Nombre / Razón Social</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Dirección</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var cliente in clientes)
                        {
                            <tr>
                                <td>
                                    <span class="badge @GetBadgeClass(cliente.TipoIdentificacion)">
                                        @cliente.TipoIdentificacion
                                    </span>
                                </td>
                                <td><code>@cliente.CedulaRuc</code></td>
                                <td><strong>@cliente.Nombre</strong></td>
                                <td>
                                    <i class="fa-solid fa-phone text-muted me-1"></i>
                                    @cliente.Telefono
                                </td>
                                <td>
                                    <i class="fa-solid fa-envelope text-muted me-1"></i>
                                    @cliente.Correo
                                </td>
                                <td class="small">@cliente.Direccion</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-warning me-1" 
                                            @onclick="() => EditarCliente(cliente)"
                                            title="Editar cliente">
                                        <i class="fa-solid fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            @onclick="() => EliminarCliente(cliente.Id)"
                                            title="Eliminar cliente">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private List<Cliente>? clientes;
    private Cliente clienteEditando = new Cliente();
    private bool mostrarFormulario = false;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;
    private string mensajeValidacionCedula = string.Empty;
    private string mensajeValidacionTelefono = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes();
    }

    private async Task CargarClientes()
    {
        try
        {
            clientes = await Http.GetFromJsonAsync<List<Cliente>>("api/clientes");
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar clientes: {ex.Message}";
        }
    }

    private void MostrarFormularioNuevo()
    {
        clienteEditando = new Cliente();
        mostrarFormulario = true;
        LimpiarMensajes();
    }

    private void EditarCliente(Cliente cliente)
    {
        clienteEditando = new Cliente
        {
            Id = cliente.Id,
            TipoIdentificacion = cliente.TipoIdentificacion,
            Nombre = cliente.Nombre,
            CedulaRuc = cliente.CedulaRuc,
            Telefono = cliente.Telefono,
            Correo = cliente.Correo,
            Direccion = cliente.Direccion
        };
        mostrarFormulario = true;
        LimpiarMensajes();
    }

    private async Task GuardarCliente()
    {
        LimpiarMensajes();

        // Validar Tipo de Identificación
        if (string.IsNullOrEmpty(clienteEditando.TipoIdentificacion))
        {
            mensajeError = "Debe seleccionar el tipo de identificación";
            return;
        }

        // Validar según tipo
        if (!ValidarIdentificacion(clienteEditando.TipoIdentificacion, clienteEditando.CedulaRuc))
        {
            return;
        }

        // Validar Teléfono
        if (!ValidarTelefono(clienteEditando.Telefono))
        {
            mensajeValidacionTelefono = "El teléfono debe tener exactamente 10 dígitos";
            return;
        }

        // Validar Dirección
        if (string.IsNullOrWhiteSpace(clienteEditando.Direccion))
        {
            mensajeError = "La dirección es obligatoria para facturación electrónica";
            return;
        }

        try
        {
            HttpResponseMessage response;

            if (clienteEditando.Id == 0)
            {
                response = await Http.PostAsJsonAsync("api/clientes", clienteEditando);
            }
            else
            {
                response = await Http.PutAsJsonAsync($"api/clientes/{clienteEditando.Id}", clienteEditando);
            }

            if (response.IsSuccessStatusCode)
            {
                mensajeExito = clienteEditando.Id == 0 
                    ? "Cliente registrado exitosamente. Listo para facturación electrónica." 
                    : "Cliente actualizado exitosamente";
                await CargarClientes();
                await Task.Delay(1500);
                CancelarEdicion();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                mensajeError = $"Error al guardar: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
    }

    private async Task EliminarCliente(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "¿Está seguro de eliminar este cliente?\n\nNota: Si tiene facturas asociadas, no se podrá eliminar."))
        {
            try
            {
                var response = await Http.DeleteAsync($"api/clientes/{id}");

                if (response.IsSuccessStatusCode)
                {
                    mensajeExito = "Cliente eliminado exitosamente";
                    await CargarClientes();
                }
                else
                {
                    mensajeError = "Error al eliminar el cliente. Verifique que no tenga facturas asociadas.";
                }
            }
            catch (Exception ex)
            {
                mensajeError = $"Error: {ex.Message}";
            }
        }
    }

    private void CancelarEdicion()
    {
        mostrarFormulario = false;
        clienteEditando = new Cliente();
        LimpiarMensajes();
    }

    private void LimpiarMensajes()
    {
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
        mensajeValidacionCedula = string.Empty;
        mensajeValidacionTelefono = string.Empty;
    }

    private bool ValidarIdentificacion(string tipo, string numero)
    {
        if (string.IsNullOrWhiteSpace(numero))
        {
            mensajeValidacionCedula = "El número de identificación es requerido";
            return false;
        }

        switch (tipo)
        {
            case "CEDULA":
                if (numero.Length != 10 || !Regex.IsMatch(numero, @"^\d{10}$"))
                {
                    mensajeValidacionCedula = "La cédula debe tener exactamente 10 dígitos numéricos";
                    return false;
                }
                // Validar algoritmo de cédula ecuatoriana
                if (!ValidarCedulaEcuatoriana(numero))
                {
                    mensajeValidacionCedula = "La cédula no es válida según el algoritmo del SRI";
                    return false;
                }
                break;

            case "RUC":
                if (numero.Length != 13 || !Regex.IsMatch(numero, @"^\d{13}$"))
                {
                    mensajeValidacionCedula = "El RUC debe tener exactamente 13 dígitos numéricos";
                    return false;
                }
                // El RUC debe terminar en 001
                if (!numero.EndsWith("001"))
                {
                    mensajeValidacionCedula = "El RUC debe terminar en 001";
                    return false;
                }
                break;

            case "PASAPORTE":
                if (numero.Length < 5 || numero.Length > 20)
                {
                    mensajeValidacionCedula = "El pasaporte debe tener entre 5 y 20 caracteres";
                    return false;
                }
                break;
        }

        return true;
    }

    private bool ValidarCedulaEcuatoriana(string cedula)
    {
        // Algoritmo de validación de cédula ecuatoriana
        if (cedula.Length != 10) return false;

        int[] coeficientes = { 2, 1, 2, 1, 2, 1, 2, 1, 2 };
        int suma = 0;
        int digitoVerificador = int.Parse(cedula[9].ToString());

        for (int i = 0; i < 9; i++)
        {
            int digito = int.Parse(cedula[i].ToString()) * coeficientes[i];
            if (digito > 9) digito -= 9;
            suma += digito;
        }

        int resultado = suma % 10 == 0 ? 0 : 10 - (suma % 10);
        return resultado == digitoVerificador;
    }

    private bool ValidarTelefono(string? telefono)
    {
        if (string.IsNullOrWhiteSpace(telefono)) 
        {
            mensajeValidacionTelefono = "El teléfono es requerido";
            return false;
        }
        
        if (telefono.Length != 10 || !Regex.IsMatch(telefono, @"^\d{10}$"))
        {
            return false;
        }

        return true;
    }

    private string GetPlaceholderIdentificacion()
    {
        return clienteEditando.TipoIdentificacion switch
        {
            "CEDULA" => "Ej: 1234567890",
            "RUC" => "Ej: 1234567890001",
            "PASAPORTE" => "Ej: ABC123456",
            _ => "Seleccione tipo de identificación"
        };
    }

    private string GetInfoIdentificacion()
    {
        return clienteEditando.TipoIdentificacion switch
        {
            "CEDULA" => "10 dígitos. Se validará con algoritmo del SRI",
            "RUC" => "13 dígitos. Debe terminar en 001",
            "PASAPORTE" => "Alfanumérico, entre 5 y 20 caracteres",
            _ => "Seleccione el tipo de identificación primero"
        };
    }

    private string GetBadgeClass(string? tipo)
    {
        return tipo switch
        {
            "CEDULA" => "bg-primary",
            "RUC" => "bg-success",
            "PASAPORTE" => "bg-info",
            _ => "bg-secondary"
        };
    }

    public class Cliente
    {
        public int Id { get; set; }

        [Required(ErrorMessage = "El tipo de identificación es requerido")]
        public string TipoIdentificacion { get; set; } = string.Empty;

        [Required(ErrorMessage = "El nombre es requerido")]
        [StringLength(200, MinimumLength = 3, ErrorMessage = "El nombre debe tener entre 3 y 200 caracteres")]
        public string Nombre { get; set; } = string.Empty;

        [Required(ErrorMessage = "La identificación es requerida")]
        public string CedulaRuc { get; set; } = string.Empty;

        [Required(ErrorMessage = "El teléfono es requerido")]
        public string? Telefono { get; set; }

        [Required(ErrorMessage = "El correo es requerido")]
        [EmailAddress(ErrorMessage = "El formato del correo no es válido")]
        public string Correo { get; set; } = string.Empty;

        [Required(ErrorMessage = "La dirección es requerida")]
        public string? Direccion { get; set; }
    }
}
