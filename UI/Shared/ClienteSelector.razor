@inject HttpClient Http

<div class="mb-3 position-relative">
    <label class="form-label">@Label</label>
    <input type="text" 
           class="form-control @(IsValid ? "" : "is-invalid")" 
           value="@searchText"
           @oninput="OnSearchTextChanged"
           @onfocus="OnFocus"
           @onblur="OnBlur"
           placeholder="Buscar por nombre o cÃ©dula..."
           autocomplete="off" />
    
    @if (!IsValid && !string.IsNullOrEmpty(ValidationMessage))
    {
        <div class="invalid-feedback d-block">@ValidationMessage</div>
    }
    
    @if (showDropdown && clientesFiltrados.Any())
    {
        <div class="autocomplete-dropdown">
            @foreach (var cliente in clientesFiltrados.Take(10))
            {
                <div class="autocomplete-item" @onmousedown="() => SeleccionarCliente(cliente)">
                    <div class="fw-bold">@cliente.NombreRazonSocial</div>
                    <small class="text-muted">@cliente.Identificacion</small>
                </div>
            }
        </div>
    }
    
    @if (clienteSeleccionado != null)
    {
        <div class="mt-2">
            <span class="badge bg-primary">
                <i class="fas fa-user me-1"></i>
                @clienteSeleccionado.NombreRazonSocial - @clienteSeleccionado.Identificacion
                <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" @onclick="LimpiarSeleccion"></button>
            </span>
        </div>
    }
</div>

<style>
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 0.25rem;
    }
    
    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.15s;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item:hover {
        background-color: #f8f9fa;
    }
</style>

@code {
    [Parameter] public int SelectedClienteId { get; set; }
    [Parameter] public EventCallback<int> SelectedClienteIdChanged { get; set; }
    [Parameter] public string Label { get; set; } = "Cliente";
    [Parameter] public bool IsValid { get; set; } = true;
    [Parameter] public string ValidationMessage { get; set; } = "";

    private List<ClienteDto> clientes = new();
    private List<ClienteDto> clientesFiltrados = new();
    private ClienteDto? clienteSeleccionado;
    private string searchText = "";
    private bool showDropdown = false;
    private bool isBlurring = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes();
    }

    private async Task CargarClientes()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<ClienteDto>>("api/clientes");
            clientes = response ?? new List<ClienteDto>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando clientes: {ex.Message}");
        }
    }

    protected override void OnParametersSet()
    {
        if (SelectedClienteId > 0 && clienteSeleccionado?.Id != SelectedClienteId)
        {
            clienteSeleccionado = clientes.FirstOrDefault(c => c.Id == SelectedClienteId);
            if (clienteSeleccionado != null)
            {
                searchText = clienteSeleccionado.NombreRazonSocial;
            }
        }
        
        FiltrarClientes();
    }

    private void FiltrarClientes()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            clientesFiltrados = new();
            return;
        }

        var searchLower = searchText.ToLower();
        clientesFiltrados = clientes
            .Where(c => 
                c.NombreRazonSocial.ToLower().Contains(searchLower) ||
                c.Identificacion.Contains(searchText))
            .OrderBy(c => c.NombreRazonSocial)
            .ToList();
    }

    private void OnSearchTextChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        showDropdown = true;
        FiltrarClientes();
    }

    private void OnFocus()
    {
        showDropdown = true;
        FiltrarClientes();
    }

    private async Task OnBlur()
    {
        isBlurring = true;
        await Task.Delay(200); // Delay para permitir el click en el dropdown
        if (isBlurring)
        {
            showDropdown = false;
        }
    }

    private async Task SeleccionarCliente(ClienteDto cliente)
    {
        isBlurring = false;
        clienteSeleccionado = cliente;
        searchText = cliente.NombreRazonSocial;
        SelectedClienteId = cliente.Id;
        showDropdown = false;
        await SelectedClienteIdChanged.InvokeAsync(cliente.Id);
    }

    private async Task LimpiarSeleccion()
    {
        clienteSeleccionado = null;
        searchText = "";
        SelectedClienteId = 0;
        clientesFiltrados = new();
        await SelectedClienteIdChanged.InvokeAsync(0);
    }

    public class ClienteDto
    {
        public int Id { get; set; }
        public string NombreRazonSocial { get; set; } = string.Empty;
        public string Identificacion { get; set; } = string.Empty;
    }
}
